<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple CMA</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <!-- Babel to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Google Maps Places API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyABw7DX0sg8fmhPt9H6JdlIGO-GikNgWhI&libraries=places"
        async defer></script>
    <style>
        /* Custom styles for printing and animations */
        @media print {
            body * {
                visibility: hidden;
            }

            #print-area,
            #print-area * {
                visibility: visible;
            }

            #print-area {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
            }

            .print-hidden {
                display: none;
            }
        }

        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Smooth scrolling for the entire page */
        html {
            scroll-behavior: smooth;
        }

        /* Custom scrollbar for comparable properties grid */
        .comps-container {
            max-height: 70vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #0ea5e9 #e2e8f0;
        }

        .comps-container::-webkit-scrollbar {
            width: 8px;
        }

        .comps-container::-webkit-scrollbar-track {
            background: #e2e8f0;
            border-radius: 4px;
        }

        .comps-container::-webkit-scrollbar-thumb {
            background: #0ea5e9;
            border-radius: 4px;
        }

        .comps-container::-webkit-scrollbar-thumb:hover {
            background: #0284c7;
        }

        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
    </style>
</head>

<body class="bg-slate-50 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        // --- ENHANCED CMA FETCH - Gets both Active and Closed Comparables ---
        const fetchComps = async (city, sqft, yearBuilt, address, radiusMiles = 2, sqftDelta = 700, monthsBack = 6, latitude = null, longitude = null) => {
            //console.log('Fetching CMA comparables:', { city, sqft, yearBuilt, address, radiusMiles, sqftDelta, monthsBack, latitude, longitude });

            const params = new URLSearchParams();
            if (address) params.set('address', address);
            if (city) params.set('city', city);
            if (sqft) params.set('sqft', sqft);
            if (latitude) params.set('latitude', latitude);
            if (longitude) params.set('longitude', longitude);
            params.set('radius_miles', radiusMiles);
            params.set('sqft_delta', sqftDelta);
            params.set('months_back', monthsBack);

            const res = await fetch(`/api/cma-comparables?${params.toString()}`);
            //console.log('CMA API response status:', res.status);

            if (!res.ok) {
                console.error('Failed to fetch CMA comparables:', await res.text());
                return { active: [], closed: [], combined: [] };
            }

            const data = await res.json();
            //console.log('Fetched CMA data:', data);

            return {
                active: data.active || [],
                closed: data.closed || [],
                combined: data.combined || [],
                counts: data.counts || { active: 0, closed: 0, total: 0 },
                meta: data.meta || {}
            };
        };

        // --- ADJUSTMENT VALUES ---
        const ADJUSTMENT_VALUES = {
            BATH_FULL: 5000, BATH_HALF: 3000, GARAGE_STALL: 8000, BASEMENT_SQFT: 40,
            CONDITION: { 'Needs Major Work': -30000, 'Dated': -15000, 'Average': 0, 'Recently Updated': 15000, 'Fully Remodeled': 30000, 'New Construction': 40000, }
        };

        const HOME_STYLES = ["", "1.5 Story", "2 Story", "Ranch", "Multi-Level", "Split Entry", "Raised Ranch", "Tri-Level"];

        // --- HELPER COMPONENTS ---
        const ProgressBar = ({ step, setStep }) => {
            const steps = ['Property Details', 'Select Comps', 'View Report'];

            const handleStepClick = (newStep) => {
                // Allow navigation only if the new step is not the current one.
                // You could add more complex logic here, e.g., preventing jumps to the report
                // if no comps are selected.
                if (newStep !== step) {
                    setStep(newStep);
                }
            };

            return (
                <nav aria-label="Progress">
                    <ol role="list" className="flex items-center">
                        {steps.map((name, index) => {
                            const stepNumber = index + 1;
                            const isCompleted = step > stepNumber;
                            const isCurrent = step === stepNumber;

                            return (
                                <li key={name} className={`relative ${index !== steps.length - 1 ? 'flex-1' : ''}`}>
                                    <div
                                        className={`flex items-center text-sm font-medium cursor-pointer transition-colors duration-200 ${isCurrent || isCompleted ? 'text-sky-600' : 'text-gray-500 hover:text-gray-700'}`}
                                        onClick={() => handleStepClick(stepNumber)}
                                    >
                                        <span className={`flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full border-2 ${isCurrent ? 'border-sky-600' : isCompleted ? 'border-sky-600 bg-sky-600' : 'border-gray-300'}`}>
                                            {isCompleted ? (
                                                <svg className="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                                    <path fillRule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clipRule="evenodd" />
                                                </svg>
                                            ) : (
                                                <span className={isCurrent ? 'text-sky-600' : 'text-gray-500'}>{stepNumber}</span>
                                            )}
                                        </span>
                                        <div className="ml-4 text-left">
                                            <p className="text-xs text-gray-500">Step {stepNumber}</p>
                                            <p className="font-semibold">{name}</p>
                                        </div>
                                    </div>

                                    {/* Connector */}
                                    {index !== steps.length - 1 && (
                                        <div className="absolute inset-0 top-5 left-4 -z-10 ml-4 h-0.5 w-full bg-gray-200" aria-hidden="true">
                                            {isCompleted && <div className="h-0.5 w-full bg-sky-600" />}
                                        </div>
                                    )}
                                </li>
                            );
                        })}
                    </ol>
                </nav>
            );
        };

        // --- APP STEPS ---
        const SubjectPropertyStep = ({ subjectProperty, setSubjectProperty, nextStep, propertyDetailsError, setPropertyDetailsError }) => {
            const addressInputRef = React.useRef(null);
            const autocompleteRef = React.useRef(null);
            const [isSearching, setIsSearching] = useState(false);
            const [searchMessage, setSearchMessage] = useState('');
            const [comparisonSummary, setComparisonSummary] = useState(null);
            const [propertyPhotos, setPropertyPhotos] = useState([]);
            const [isLoadingDetails, setIsLoadingDetails] = useState(false);
            const [manualAddressMode, setManualAddressMode] = useState(false);
            const [googleSelectedAddress, setGoogleSelectedAddress] = useState('');

            const handlePropertyDetailsFromAddress = async (address) => {
                if (!address) return;

                setIsLoadingDetails(true);
                setSearchMessage('Searching property database...');

                try {
                    const response = await fetch('/api/property-details-from-address', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ address })
                    });

                    const data = await response.json();

                    if (data.error) {
                        setSearchMessage('Property not found in our database');
                        setPropertyDetailsError('Unable to retrieve complete property details from our database.');
                        return;
                    }

                    // Debug: Log the API response to see what coordinates we're getting
                    // Fill form fields with returned property data (extended mapping)
                    setSubjectProperty(prev => {
                        const newProperty = {
                            ...prev,
                            address: data.UnparsedAddress || data.address || prev.address,
                            city: data.City || prev.city,
                            sqft: data.LivingArea || data.AboveGradeFinishedArea || data.LivingAreaTotal || prev.sqft,
                            basementSqft: data.BelowGradeFinishedArea || data.BasementFinishedArea || prev.basementSqft,
                            yearBuilt: data.YearBuilt || prev.yearBuilt,
                            beds: data.BedroomsTotal || data.Bedrooms || prev.beds,
                            baths: data.BathroomsTotalInteger || data.BathroomsTotal || data.BathroomsFull || prev.baths,
                            garage: data.GarageSpaces || data.ParkingTotal || prev.garage,
                            condition: Array.isArray(data.PropertyCondition) && data.PropertyCondition.length > 0
                                ? data.PropertyCondition[0] : prev.condition,
                            style: Array.isArray(data.ArchitecturalStyle) && data.ArchitecturalStyle.length > 0
                                ? data.ArchitecturalStyle[0] : prev.style,
                            propertyType: data.PropertyType || prev.propertyType,
                            propertySubType: data.PropertySubType || prev.propertySubType,
                            listPrice: data.ListPrice || prev.listPrice,
                            soldPrice: data.ClosePrice || data.SoldPrice || prev.soldPrice,
                            lotSizeAcres: data.LotSizeAcres || prev.lotSizeAcres,
                            lotSizeSquareFeet: data.LotSizeSquareFeet || prev.lotSizeSquareFeet,
                            stories: data.StoriesTotal || data.Stories || prev.stories,
                            dom: data.DaysOnMarket || data.CumulativeDaysOnMarket || prev.dom,
                            pricePerSqft: (data.ListPrice && (data.LivingArea || data.AboveGradeFinishedArea))
                                ? Math.round(data.ListPrice / (data.LivingArea || data.AboveGradeFinishedArea))
                                : prev.pricePerSqft,
                            // Add coordinates for distance calculations
                            latitude: data.Latitude || prev.latitude,
                            longitude: data.Longitude || prev.longitude,
                            // Add subdivision for comparison and filtering
                            subdivision: data.SubdivisionName || prev.subdivision
                        };
                        return newProperty;
                    });

                    // Handle photos
                    if (data.Media && Array.isArray(data.Media)) {
                        const photos = data.Media
                            .filter(m => m.MediaCategory === 'Photo' && m.MediaURL)
                            .sort((a, b) => (a.Order || 0) - (b.Order || 0))
                            .slice(0, 12); // Limit to first 12 photos
                        setPropertyPhotos(photos);
                    }

                    // Create status message with property type info
                    let statusMessage = `Property details loaded successfully!`;
                    if (data.PropertyType) {
                        statusMessage += ` Property Type: ${data.PropertyType}`;
                        if (data.PropertySubType) {
                            statusMessage += ` (${data.PropertySubType})`;
                        }
                    }
                    if (data.Media?.length) {
                        statusMessage += ` | Found ${data.Media.length} photos`;
                    }
                    if (data.PropertyType === 'Land') {
                        statusMessage += ` | Note: Land properties may have limited residential details`;
                    }

                    setSearchMessage(statusMessage);
                    setPropertyDetailsError('');
                } catch (error) {
                    console.error('Error fetching property details:', error);
                    setSearchMessage('Unable to retrieve property details at this time');
                    setPropertyDetailsError('Property database temporarily unavailable.');
                } finally {
                    setIsLoadingDetails(false);
                }
            };

            const handlePropertySearch = async () => {
                if (!subjectProperty.address) {
                    setSearchMessage('Please enter an address first');
                    return;
                }

                setIsSearching(true);
                setSearchMessage('');

                try {
                    const response = await fetch(`/api/property-search?address=${encodeURIComponent(subjectProperty.address)}`);
                    const data = await response.json();

                    if (data.found) {
                        // Auto-fill the form with found property details
                        setSubjectProperty(prev => ({
                            ...prev,
                            city: data.city || prev.city,
                            sqft: data.sqft || prev.sqft,
                            basementSqft: data.belowGradeSqft || prev.basementSqft,
                            yearBuilt: data.yearBuilt || prev.yearBuilt,
                            beds: data.beds || prev.beds,
                            baths: data.baths || prev.baths,
                            garage: data.garage || prev.garage,
                            condition: data.condition || prev.condition,
                            propertyType: data.propertyType || prev.propertyType
                        }));
                        setSearchMessage(`Property details found and loaded! MLS #: ${data.mlsNumber}`);
                        setPropertyDetailsError('');
                        // After auto-fill, fetch nearby comps and compute quick comparison stats
                        try {
                            const radius = subjectProperty.radiusMiles || data.radiusMiles || 2;
                            const sqftDelta = subjectProperty.sqftDelta || data.sqftDelta || 700;
                            const params = new URLSearchParams({ address: data.address, city: data.city || subjectProperty.city || '', radius_miles: radius, sqft_delta: sqftDelta });
                            const compsResp = await fetch(`/api/comps-from-address?${params.toString()}`);
                            if (compsResp.ok) {
                                const compsData = await compsResp.json();
                                const comps = compsData.comps || [];
                                if (comps.length > 0) {
                                    const sqfts = comps.map(c => Number(c.sqft || 0)).filter(n => n > 0).sort((a, b) => a - b);
                                    const avgSqft = sqfts.reduce((a, b) => a + b, 0) / sqfts.length;
                                    const medianSqft = sqfts.length % 2 === 1 ? sqfts[(sqfts.length - 1) / 2] : ((sqfts[sqfts.length / 2 - 1] + sqfts[sqfts.length / 2]) / 2);
                                    const avgPPSF = comps.filter(c => c.soldPrice && c.sqft && c.sqft > 0).reduce((acc, c) => acc + (c.soldPrice / c.sqft), 0) / Math.max(1, comps.filter(c => c.soldPrice && c.sqft && c.sqft > 0).length);
                                    const nearest = comps.filter(c => c.distance_miles !== undefined).sort((a, b) => a.distance_miles - b.distance_miles)[0];
                                    setComparisonSummary({ count: comps.length, avgSqft: Math.round(avgSqft), medianSqft: Math.round(medianSqft), avgPPSF: Math.round(avgPPSF || 0), nearestDistance: nearest ? Number(nearest.distance_miles.toFixed(2)) : null });
                                } else {
                                    setComparisonSummary({ count: 0 });
                                }
                            }
                        } catch (err) {
                            console.error('Error fetching comps for comparison:', err);
                        }
                    } else {
                        setSearchMessage('Property not found in our database. Please enter details manually.');
                        setPropertyDetailsError('Property details not available in our system.');
                    }
                } catch (error) {
                    console.error('Property search error:', error);
                    setSearchMessage('Search temporarily unavailable. Please enter details manually.');
                    setPropertyDetailsError('Unable to connect to property database.');
                }

                setIsSearching(false);
            };


            const handleChange = (e) => {
                const { name, value, type } = e.target;
                setSubjectProperty(prev => ({
                    ...prev,
                    [name]: type === 'number' ? (value === '' ? '' : parseFloat(value)) : value
                }));
                //console.log('Form change:', name, value, type);
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                // Basic validation for required fields - only address and city are required
                if (!subjectProperty.address || !subjectProperty.city) {
                    alert('Please fill in Address and City');
                    return;
                }
                //console.log('Subject Property Data on Submit:', subjectProperty);
                nextStep();
            };

            useEffect(() => {
                //console.log('SubjectPropertyStep mounted');

                // Initialize Google Places Autocomplete
                if (window.google && window.google.maps && addressInputRef.current) {
                    autocompleteRef.current = new window.google.maps.places.Autocomplete(
                        addressInputRef.current,
                        {
                            types: ['address'],
                            componentRestrictions: { country: 'us' },
                            fields: ['address_components', 'formatted_address', 'geometry']
                        }
                    );

                    autocompleteRef.current.addListener('place_changed', () => {
                        const place = autocompleteRef.current.getPlace();

                        if (place.address_components) {
                            // Helper to find the first matching component for a list of types
                            const findComponent = (typesToCheck) => {
                                for (const comp of place.address_components) {
                                    for (const t of typesToCheck) {
                                        if (comp.types && comp.types.indexOf(t) !== -1) return comp.long_name;
                                    }
                                }
                                return '';
                            };

                            const streetNumber = findComponent(['street_number']);
                            const route = findComponent(['route']);
                            // city can be returned under different component types depending on the place
                            const city = findComponent(['locality', 'postal_town', 'administrative_area_level_3', 'neighborhood', 'sublocality']) || '';
                            const state = findComponent(['administrative_area_level_1']);
                            const postal = findComponent(['postal_code']);

                            const address = ((streetNumber ? streetNumber + ' ' : '') + (route || '')).trim();
                            const fullGoogleAddress = place.formatted_address || address;

                            // Store what Google selected for potential manual override
                            setGoogleSelectedAddress(fullGoogleAddress);

                            // Check if Google selected a unit number that might be wrong
                            const hasUnit = /\s#\s?\d+/i.test(fullGoogleAddress) || /\bunit\s+\d+/i.test(fullGoogleAddress) || /\bapt\s+\d+/i.test(fullGoogleAddress);

                            if (hasUnit) {
                                setSearchMessage(`Found "${fullGoogleAddress}" - If this includes an incorrect unit number, use the address override option below.`);
                            }

                            setSubjectProperty(prev => ({
                                ...prev,
                                address: address || place.formatted_address || prev.address,
                                city: city || prev.city,
                                state: state || prev.state,
                                postalCode: postal || prev.postalCode,
                                // if geometry available, capture coords
                                ...(place.geometry && place.geometry.location ? { latitude: place.geometry.location.lat(), longitude: place.geometry.location.lng() } : {})
                            }));

                            // --- Auto-trigger property details fetch only if not in manual mode ---
                            if (!manualAddressMode) {
                                const searchAddress = (address || place.formatted_address || '').trim();
                                if (searchAddress) {
                                    handlePropertyDetailsFromAddress(searchAddress);
                                }
                            }
                        }
                    });
                }
            }, []);

            const handleManualAddressOverride = () => {
                setManualAddressMode(true);
                setSearchMessage('You can now edit the address to search for the correct property');

                // Clear any previous auto-search results
                setPropertyPhotos([]);
                setPropertyDetailsError('');

                // Disable Google autocomplete temporarily
                if (autocompleteRef.current) {
                    autocompleteRef.current.setOptions({ types: [] });
                }
            };

            const handleManualAddressSearch = () => {
                const searchAddress = subjectProperty.address.trim();
                if (searchAddress) {
                    handlePropertyDetailsFromAddress(searchAddress);
                } else {
                    setSearchMessage('Please enter a complete address to search');
                }
            };

            const resetToGoogleMode = () => {
                setManualAddressMode(false);
                setSearchMessage('');

                // Re-enable Google autocomplete
                if (autocompleteRef.current) {
                    autocompleteRef.current.setOptions({
                        types: ['address'],
                        componentRestrictions: { country: 'us' }
                    });
                }

                // If there was a Google selected address, restore it
                if (googleSelectedAddress) {
                    setSubjectProperty(prev => ({
                        ...prev,
                        address: googleSelectedAddress
                    }));
                }
            };

            return (
                <div className="animate-fade-in">
                    <div className="text-center mb-8">
                        <h2 className="text-3xl font-bold text-gray-900 mb-3">Step 1: Subject Property Details</h2>
                        <p className="text-lg text-gray-600 max-w-2xl mx-auto">Start by entering the property address.</p>
                    </div>

                    <form onSubmit={handleSubmit} className="max-w-4xl mx-auto bg-gradient-to-br from-white to-gray-50 p-8 rounded-2xl shadow-xl border border-gray-200">
                        {/* Address Section */}
                        <div className="mb-8">
                            <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <svg className="w-5 h-5 mr-2 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                Property Location
                            </h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="space-y-2">
                                    <label htmlFor="address" className="flex items-center text-sm font-semibold text-gray-800">
                                        <span className="text-red-500 mr-1">*</span>
                                        Property Address
                                        {manualAddressMode && (
                                            <span className="ml-2 text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Custom Address</span>
                                        )}
                                    </label>
                                    <div className="relative">
                                        <input
                                            ref={addressInputRef}
                                            type="text"
                                            name="address"
                                            id="address"
                                            value={subjectProperty.address}
                                            onChange={handleChange}
                                            required
                                            className={`w-full pl-4 pr-4 py-3 text-sm bg-white border-2 rounded-lg shadow-sm transition-all duration-200 hover:border-gray-300 font-medium ${manualAddressMode
                                                    ? 'border-blue-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200'
                                                    : 'border-gray-200 focus:border-sky-500 focus:ring-2 focus:ring-sky-200'
                                                }`}
                                            placeholder="üè† Start typing an address..."
                                        />
                                    </div>

                                    {/* Address Control Buttons */}
                                    <div className="flex flex-wrap gap-2 mt-2">
                                        {!manualAddressMode ? (
                                            <>
                                                {googleSelectedAddress && (
                                                    <div className="text-xs text-gray-600 bg-gray-50 px-2 py-1 rounded">
                                                        Auto-detected: {googleSelectedAddress}
                                                    </div>
                                                )}
                                                <button
                                                    type="button"
                                                    onClick={handleManualAddressOverride}
                                                    className="text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-full transition-colors"
                                                >
                                                    ‚úèÔ∏è Edit Address
                                                </button>
                                            </>
                                        ) : (
                                            <>
                                                <button
                                                    type="button"
                                                    onClick={handleManualAddressSearch}
                                                    disabled={isLoadingDetails}
                                                    className="text-xs bg-sky-100 hover:bg-sky-200 text-sky-800 px-3 py-1 rounded-full transition-colors disabled:opacity-50"
                                                >
                                                    üîç Search Property
                                                </button>
                                                <button
                                                    type="button"
                                                    onClick={resetToGoogleMode}
                                                    className="text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-full transition-colors"
                                                >
                                                    ‚Ü∂ Auto-Complete
                                                </button>
                                            </>
                                        )}
                                    </div>
                                </div>
                                <div className="space-y-2">
                                    <label htmlFor="city" className="flex items-center text-sm font-semibold text-gray-800">
                                        <span className="text-red-500 mr-1">*</span>
                                        City
                                    </label>
                                    <div className="relative">
                                        <input
                                            type="text"
                                            name="city"
                                            id="city"
                                            value={subjectProperty.city}
                                            onChange={handleChange}
                                            required
                                            className="w-full pl-4 pr-4 py-3 text-sm bg-white border-2 border-gray-200 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 transition-all duration-200 hover:border-gray-300 font-medium"
                                            placeholder="üåÜ e.g. Omaha"
                                        />
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Property Details Section */}
                        <div className="mb-8">
                            <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <svg className="w-5 h-5 mr-2 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z" />
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 21l0-12 8 0 0 12" />
                                </svg>
                                Property Specifications
                            </h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div className="space-y-2">
                                    <label htmlFor="sqft" className="text-sm font-semibold text-gray-800">üìê Above-Grade Sq. Ft.</label>
                                    <input type="number" name="sqft" id="sqft" value={subjectProperty.sqft} onChange={handleChange}
                                        className="w-full pl-4 pr-4 py-3 text-sm bg-white border-2 border-gray-200 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 transition-all duration-200 hover:border-gray-300 font-medium"
                                        placeholder="1800" />
                                </div>
                                <div className="space-y-2">
                                    <label htmlFor="basementSqft" className="text-sm font-semibold text-gray-800">üè† Finished Basement Sq. Ft.</label>
                                    <input type="number" name="basementSqft" id="basementSqft" value={subjectProperty.basementSqft} onChange={handleChange}
                                        className="w-full pl-4 pr-4 py-3 text-sm bg-white border-2 border-gray-200 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 transition-all duration-200 hover:border-gray-300 font-medium"
                                        placeholder="800" />
                                </div>
                                <div className="space-y-2">
                                    <label htmlFor="yearBuilt" className="text-sm font-semibold text-gray-800">üóìÔ∏è Year Built</label>
                                    <input type="number" name="yearBuilt" id="yearBuilt" value={subjectProperty.yearBuilt} onChange={handleChange}
                                        className="w-full pl-4 pr-4 py-3 text-sm bg-white border-2 border-gray-200 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 transition-all duration-200 hover:border-gray-300 font-medium"
                                        placeholder="2005" />
                                </div>
                            </div>
                        </div>

                        {/* Search Parameters */}
                        <div className="mb-8">
                            <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <svg className="w-5 h-5 mr-2 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                Search Parameters
                            </h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="space-y-2">
                                    <label htmlFor="radiusMiles" className="text-sm font-semibold text-gray-800">üéØ Search Radius (miles)</label>
                                    <input
                                        type="number"
                                        name="radiusMiles"
                                        id="radiusMiles"
                                        min="0.25"
                                        step="0.25"
                                        value={subjectProperty.radiusMiles}
                                        onChange={handleChange}
                                        className="w-full pl-4 pr-4 py-3 text-sm bg-white border-2 border-gray-200 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 transition-all duration-200 hover:border-gray-300 font-medium"
                                        placeholder="1.0"
                                    />
                                </div>
                                <div className="space-y-2">
                                    <label htmlFor="sqftDelta" className="text-sm font-semibold text-gray-800">üìè Sqft Delta (¬±)</label>
                                    <input
                                        type="number"
                                        name="sqftDelta"
                                        id="sqftDelta"
                                        min="100"
                                        step="50"
                                        value={subjectProperty.sqftDelta}
                                        onChange={handleChange}
                                        className="w-full pl-4 pr-4 py-3 text-sm bg-white border-2 border-gray-200 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 transition-all duration-200 hover:border-gray-300 font-medium"
                                        placeholder="500"
                                    />
                                </div>
                            </div>
                        </div>

                        {/* Room Details */}
                        <div className="mb-8">
                            <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <svg className="w-5 h-5 mr-2 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" />
                                </svg>
                                Room Details
                            </h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div className="space-y-2">
                                    <label htmlFor="beds" className="text-sm font-semibold text-gray-800">üõèÔ∏è Bedrooms</label>
                                    <input type="number" name="beds" id="beds" value={subjectProperty.beds} onChange={handleChange}
                                        className="w-full pl-4 pr-4 py-3 text-sm bg-white border-2 border-gray-200 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 transition-all duration-200 hover:border-gray-300 font-medium"
                                        placeholder="4" />
                                </div>
                                <div className="space-y-2">
                                    <label htmlFor="baths" className="text-sm font-semibold text-gray-800">üõÅ Bathrooms</label>
                                    <input type="number" name="baths" id="baths" value={subjectProperty.baths} onChange={handleChange}
                                        className="w-full pl-4 pr-4 py-3 text-sm bg-white border-2 border-gray-200 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 transition-all duration-200 hover:border-gray-300 font-medium"
                                        placeholder="3" />
                                </div>
                                <div className="space-y-2">
                                    <label htmlFor="garage" className="text-sm font-semibold text-gray-800">üöó Garage Stalls</label>
                                    <input type="number" name="garage" id="garage" value={subjectProperty.garage} onChange={handleChange}
                                        className="w-full pl-4 pr-4 py-3 text-sm bg-white border-2 border-gray-200 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 transition-all duration-200 hover:border-gray-300 font-medium"
                                        placeholder="3" />
                                </div>
                            </div>
                        </div>

                        {/* Property Characteristics */}
                        <div className="mb-8">
                            <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <svg className="w-5 h-5 mr-2 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                </svg>
                                Property Characteristics
                            </h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="space-y-2">
                                    <label htmlFor="condition" className="text-sm font-semibold text-gray-800">üîß Overall Condition</label>
                                    <div className="relative">
                                        <select name="condition" id="condition" value={subjectProperty.condition} onChange={handleChange}
                                            className="w-full pl-4 pr-10 py-3 text-sm bg-white border-2 border-gray-200 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 transition-all duration-200 hover:border-gray-300 appearance-none cursor-pointer font-medium">
                                            {Object.keys(ADJUSTMENT_VALUES.CONDITION).map(cond => <option key={cond} value={cond}>{cond}</option>)}
                                        </select>
                                        <div className="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                            <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                                <div className="space-y-2">
                                    <label htmlFor="style" className="text-sm font-semibold text-gray-800">üè° Style</label>
                                    <div className="relative">
                                        <select name="style" id="style" value={subjectProperty.style} onChange={handleChange}
                                            className="w-full pl-4 pr-10 py-3 text-sm bg-white border-2 border-gray-200 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 transition-all duration-200 hover:border-gray-300 appearance-none cursor-pointer font-medium">
                                            {HOME_STYLES.map(style => <option key={style} value={style}>{style}</option>)}
                                        </select>
                                        <div className="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                            <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Submit Button */}
                        <div className="flex justify-center pt-4">
                            <button type="submit"
                                className="px-8 py-4 bg-gradient-to-r from-sky-600 to-blue-600 text-white font-semibold rounded-xl shadow-lg hover:from-sky-700 hover:to-blue-700 focus:outline-none focus:ring-4 focus:ring-sky-200 transition-all duration-200 transform hover:scale-105 flex items-center">
                                <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                                Find Comparable Properties
                            </button>
                        </div>
                    </form>

                    {/* Search Message */}
                    {(searchMessage || propertyDetailsError) && (
                        <div className={`mt-4 p-3 rounded-md border space-y-2 ${propertyDetailsError ? 'bg-red-50 border-red-200' :
                                searchMessage.includes('Found') && searchMessage.includes('unit number') ? 'bg-amber-50 border-amber-200' :
                                    searchMessage.includes('edit the address') ? 'bg-blue-50 border-blue-200' :
                                        'bg-blue-50 border-blue-200'
                            }`}>
                            {searchMessage && (
                                <p className={`text-sm ${propertyDetailsError ? 'text-red-800' :
                                        searchMessage.includes('Found') && searchMessage.includes('unit number') ? 'text-amber-800' :
                                            searchMessage.includes('edit the address') ? 'text-blue-800' :
                                                'text-blue-800'
                                    }`}>
                                    {searchMessage}
                                </p>
                            )}
                            {isLoadingDetails && (
                                <div className="mt-2 flex items-center">
                                    <div className={`animate-spin rounded-full h-4 w-4 border-b-2 ${propertyDetailsError ? 'border-red-600' : 'border-blue-600'
                                        }`}></div>
                                    <span className={`ml-2 text-xs ${propertyDetailsError ? 'text-red-600' : 'text-blue-600'
                                        }`}>Searching property database...</span>
                                </div>
                            )}
                            {propertyDetailsError && (
                                <p className="text-xs font-medium text-red-700">{propertyDetailsError}</p>
                            )}
                        </div>
                    )}

                    {/* Property Photos */}
                    {propertyPhotos.length > 0 && (
                        <div className="mt-6 bg-white p-6 rounded-lg shadow-md">
                            <h3 className="text-lg font-semibold text-gray-800 mb-4">Property Photos ({propertyPhotos.length})</h3>
                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                {propertyPhotos.map((photo, index) => (
                                    <div key={photo.MediaKey || index} className="relative group">
                                        <img
                                            src={photo.MediaURL}
                                            alt={`Property photo ${index + 1}`}
                                            className="w-full h-32 object-cover rounded-lg shadow-sm hover:shadow-md transition-shadow cursor-pointer"
                                            onClick={() => window.open(photo.MediaURL, '_blank')}
                                            onError={(e) => {
                                                e.target.style.display = 'none';
                                            }}
                                        />
                                        <div className="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-opacity rounded-lg flex items-center justify-center">
                                            <span className="text-white opacity-0 group-hover:opacity-100 text-sm">Click to enlarge</span>
                                        </div>
                                        <div className="absolute top-2 left-2 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded">
                                            {index + 1}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Manual Search Button */}
                    <div className="mt-4 p-4 bg-gray-50 rounded-lg">
                        <button
                            type="button"
                            onClick={handlePropertySearch}
                            disabled={isSearching || isLoadingDetails}
                            className="w-full inline-flex justify-center items-center rounded-md border border-gray-300 bg-white py-2 px-4 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            {isSearching ? (
                                <>
                                    <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-gray-600 mr-2"></div>
                                    Searching...
                                </>
                            ) : (
                                <>
                                    <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                    Search Property Details
                                </>
                            )}
                        </button>
                        <p className="mt-2 text-xs text-gray-500 text-center">
                            Click to manually search for property details if auto-search didn't work
                        </p>
                    </div>

                    {/* Comparison Summary */}
                    {comparisonSummary && (
                        <div className="mt-6 p-4 bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 rounded-lg">
                            <h4 className="font-semibold text-gray-800 mb-3 flex items-center">
                                <svg className="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v4a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                </svg>
                                Comparable Summary
                            </h4>
                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 text-sm">
                                <div className="bg-white p-3 rounded-md shadow-sm">
                                    <div className="text-gray-600">Found</div>
                                    <div className="font-semibold text-lg text-gray-800">{comparisonSummary.count}</div>
                                    <div className="text-xs text-gray-500">comparables</div>
                                </div>
                                {comparisonSummary.count > 0 && (
                                    <>
                                        <div className="bg-white p-3 rounded-md shadow-sm">
                                            <div className="text-gray-600">Avg GLA</div>
                                            <div className="font-semibold text-lg text-gray-800">{comparisonSummary.avgSqft.toLocaleString()}</div>
                                            <div className="text-xs text-gray-500">sq ft</div>
                                        </div>
                                        <div className="bg-white p-3 rounded-md shadow-sm">
                                            <div className="text-gray-600">Median GLA</div>
                                            <div className="font-semibold text-lg text-gray-800">{comparisonSummary.medianSqft.toLocaleString()}</div>
                                            <div className="text-xs text-gray-500">sq ft</div>
                                        </div>
                                        <div className="bg-white p-3 rounded-md shadow-sm">
                                            <div className="text-gray-600">Avg $/Sqft</div>
                                            <div className="font-semibold text-lg text-gray-800">${comparisonSummary.avgPPSF}</div>
                                            <div className="text-xs text-gray-500">per sq ft</div>
                                        </div>
                                        {comparisonSummary.nearestDistance !== null && (
                                            <div className="bg-white p-3 rounded-md shadow-sm">
                                                <div className="text-gray-600">Nearest</div>
                                                <div className="font-semibold text-lg text-gray-800">{comparisonSummary.nearestDistance}</div>
                                                <div className="text-xs text-gray-500">miles away</div>
                                            </div>
                                        )}
                                    </>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Map Component for displaying properties on Google Maps
        const MapComponent = ({ subjectProperty, comparables, selectedComps, onSelectComp }) => {
            const mapRef = React.useRef(null);
            const mapInstanceRef = React.useRef(null);
            const markersRef = React.useRef([]);

            React.useEffect(() => {
                if (!window.google || !window.google.maps) return;

                // Initialize map
                if (!mapInstanceRef.current && mapRef.current) {
                    mapInstanceRef.current = new window.google.maps.Map(mapRef.current, {
                        zoom: 13,
                        center: {
                            lat: subjectProperty.latitude || 41.180872,
                            lng: subjectProperty.longitude || -96.228298
                        },
                        mapTypeId: 'hybrid'
                    });
                }

                // Clear existing markers
                markersRef.current.forEach(marker => marker.setMap(null));
                markersRef.current = [];

                const map = mapInstanceRef.current;
                if (!map) return;

                // Add subject property marker
                if (subjectProperty.latitude && subjectProperty.longitude) {
                    const subjectMarker = new window.google.maps.Marker({
                        position: { lat: subjectProperty.latitude, lng: subjectProperty.longitude },
                        map: map,
                        title: `Subject Property: ${subjectProperty.address}`,
                        icon: {
                            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                <svg width="30" height="30" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="15" cy="15" r="12" fill="#FF6B6B" stroke="#fff" stroke-width="2"/>
                                    <text x="15" y="20" text-anchor="middle" fill="white" font-size="16">üè†</text>
                                </svg>
                            `),
                            scaledSize: new window.google.maps.Size(30, 30)
                        }
                    });

                    const subjectInfoWindow = new window.google.maps.InfoWindow({
                        content: `
                            <div class="p-2">
                                <h3 class="font-bold text-red-600">Subject Property</h3>
                                <p class="text-sm">${subjectProperty.address}</p>
                                <p class="text-xs text-gray-600">${subjectProperty.sqft || 'N/A'} sq ft ‚Ä¢ ${subjectProperty.yearBuilt || 'N/A'}</p>
                            </div>
                        `
                    });

                    subjectMarker.addListener('click', () => {
                        subjectInfoWindow.open(map, subjectMarker);
                    });

                    markersRef.current.push(subjectMarker);
                }

                // Add comparable property markers
                comparables.forEach((comp, index) => {
                    if (!comp.latitude || !comp.longitude) return;

                    const isSelected = selectedComps.some(c => c.id === comp.id);
                    const price = comp.soldPrice || comp.listPrice || 0;
                    const pricePerSqft = price && comp.sqft ? Math.round(price / comp.sqft) : 0;

                    const marker = new window.google.maps.Marker({
                        position: { lat: comp.latitude, lng: comp.longitude },
                        map: map,
                        title: `${comp.address} - $${price.toLocaleString()}`,
                        icon: {
                            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                <svg width="25" height="25" viewBox="0 0 25 25" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="12.5" cy="12.5" r="10" fill="${isSelected ? '#F59E0B' : comp.isActive ? '#10B981' : '#3B82F6'}" stroke="#fff" stroke-width="2"/>
                                    <text x="12.5" y="17" text-anchor="middle" fill="white" font-size="12">${isSelected ? '‚≠ê' : comp.isActive ? 'üü¢' : 'üîµ'}</text>
                                </svg>
                            `),
                            scaledSize: new window.google.maps.Size(25, 25)
                        }
                    });

                    const infoWindow = new window.google.maps.InfoWindow({
                        content: `
                            <div class="p-3 max-w-xs">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="font-bold text-sm">${comp.address}</h3>
                                    <span class="text-xs px-2 py-1 rounded ${comp.isActive ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">${comp.isActive ? 'Active' : 'Sold'}</span>
                                </div>
                                <p class="text-sm font-semibold text-gray-900">$${price.toLocaleString()}</p>
                                ${comp.sqft ? `<p class="text-xs text-gray-600">${comp.sqft.toLocaleString()} sq ft${pricePerSqft > 0 ? ` ‚Ä¢ $${pricePerSqft}/sq ft` : ''}</p>` : ''}
                                ${comp.distance_miles !== undefined ? `<p class="text-xs text-gray-600">${comp.distance_miles.toFixed(2)} miles away</p>` : ''}
                                <button onclick="window.toggleCompFromMap('${comp.id}')" class="mt-2 px-3 py-1 text-xs font-medium rounded ${isSelected ? 'bg-red-100 text-red-700' : 'bg-sky-100 text-sky-700'} hover:opacity-80">
                                    ${isSelected ? 'Remove' : 'Add to Comparison'}
                                </button>
                            </div>
                        `
                    });

                    marker.addListener('click', () => {
                        infoWindow.open(map, marker);
                    });

                    markersRef.current.push(marker);
                });

                // Fit map to show all markers
                if (markersRef.current.length > 0) {
                    const bounds = new window.google.maps.LatLngBounds();
                    markersRef.current.forEach(marker => {
                        bounds.extend(marker.getPosition());
                    });
                    map.fitBounds(bounds);

                    // Ensure minimum zoom level
                    window.google.maps.event.addListenerOnce(map, 'bounds_changed', () => {
                        if (map.getZoom() > 16) {
                            map.setZoom(16);
                        }
                    });
                }

            }, [subjectProperty, comparables, selectedComps]);

            // Global function for map info window buttons
            React.useEffect(() => {
                window.toggleCompFromMap = (compId) => {
                    const comp = comparables.find(c => c.id === compId);
                    if (comp) {
                        onSelectComp(comp);
                    }
                };

                return () => {
                    delete window.toggleCompFromMap;
                };
            }, [comparables, onSelectComp]);

            return (
                <div ref={mapRef} style={{ width: '100%', height: '100%' }} />
            );
        };

        const ComparablesStep = ({ subjectProperty, selectedComps, setSelectedComps, prevStep, nextStep }) => {
            useEffect(() => {
                //console.log('ComparablesStep mounted');
                setTimeout(() => {
                    const element = document.getElementById('comparables-section');
                    if (element) {
                        element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            }, []);

            const [cmaData, setCmaData] = useState({ active: [], closed: [], combined: [], counts: { active: 0, closed: 0, total: 0 } });
            const [loading, setLoading] = useState(false);
            const [sortBy, setSortBy] = useState('distance'); // distance, price, size, date
            const [filterBy, setFilterBy] = useState('all'); // all, similar_size, similar_age, similar_style, similar_subdivision, active_only, closed_only
            const [activeTab, setActiveTab] = useState('all'); // all, active, closed
            const [viewMode, setViewMode] = useState('detailed'); // detailed | compact | map
            const [visibleCount, setVisibleCount] = useState(60); // for compact view pagination

            // Expand search state
            const [showExpandSearch, setShowExpandSearch] = useState(false);
            const [expandedRadius, setExpandedRadius] = useState(subjectProperty.radiusMiles || 2);
            const [expandedSqftDelta, setExpandedSqftDelta] = useState(subjectProperty.sqftDelta || 500);

            // Modal state for property details
            const [showModal, setShowModal] = useState(false);
            const [modalProperty, setModalProperty] = useState(null);
            const [modalDetails, setModalDetails] = useState(null);
            const [modalLoading, setModalLoading] = useState(false);

            useEffect(() => {
                if (viewMode === 'compact') {
                    setVisibleCount(60);
                }
            }, [viewMode]);

            const handleExpandSearch = async () => {
                setLoading(true);
                setShowExpandSearch(false);

                try {
                    const data = await fetchComps(
                        subjectProperty.city,
                        subjectProperty.sqft,
                        subjectProperty.yearBuilt,
                        subjectProperty.address,
                        expandedRadius,
                        expandedSqftDelta,
                        6, // monthsBack
                        subjectProperty.latitude,
                        subjectProperty.longitude
                    );
                    setCmaData(data);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                setLoading(true);
                //console.log('Subject Property Debug:', subjectProperty); // Debug log
                fetchComps(
                    subjectProperty.city,
                    subjectProperty.sqft,
                    subjectProperty.yearBuilt,
                    subjectProperty.address,
                    subjectProperty.radiusMiles,
                    subjectProperty.sqftDelta,
                    6, // monthsBack
                    subjectProperty.latitude,
                    subjectProperty.longitude
                )
                    .then(data => {
                        setCmaData(data);
                        //console.log('CMA Data loaded:', data);
                    })
                    .finally(() => setLoading(false));
            }, [subjectProperty]);

            // Get the current dataset based on active tab
            const getCurrentDataset = () => {
                switch (activeTab) {
                    case 'active': return cmaData.active || [];
                    case 'closed': return cmaData.closed || [];
                    case 'all':
                    default: return cmaData.combined || [];
                }
            };

            const sortedAndFilteredComps = useMemo(() => {
                let comps = getCurrentDataset();

                // Apply filters
                if (filterBy === 'similar_size' && subjectProperty.sqft) {
                    const sizeTolerance = 500;
                    comps = comps.filter(comp =>
                        Math.abs((comp.sqft || 0) - subjectProperty.sqft) <= sizeTolerance
                    );
                } else if (filterBy === 'similar_age' && subjectProperty.yearBuilt) {
                    const ageTolerance = 10;
                    comps = comps.filter(comp =>
                        Math.abs((comp.yearBuilt || 0) - subjectProperty.yearBuilt) <= ageTolerance
                    );
                } else if (filterBy === 'similar_style' && subjectProperty.style) {
                    comps = comps.filter(comp =>
                        comp.style === subjectProperty.style
                    );
                } else if (filterBy === 'similar_subdivision' && subjectProperty.subdivision) {
                    comps = comps.filter(comp =>
                        comp.subdivision === subjectProperty.subdivision
                    );
                } else if (filterBy === 'active_only') {
                    comps = comps.filter(comp => comp.isActive === true);
                } else if (filterBy === 'closed_only') {
                    comps = comps.filter(comp => comp.isActive === false);
                }                // Apply sorting
                comps.sort((a, b) => {
                    switch (sortBy) {
                        case 'price':
                            const priceA = a.soldPrice || a.listPrice || 0;
                            const priceB = b.soldPrice || b.listPrice || 0;
                            return priceB - priceA;
                        case 'size':
                            return (b.sqft || 0) - (a.sqft || 0);
                        case 'date':
                            const dateA = new Date(a.closeDate || a.onMarketDate || 0);
                            const dateB = new Date(b.closeDate || b.onMarketDate || 0);
                            return dateB - dateA;
                        case 'distance':
                        default:
                            return (a.distance_miles || 999) - (b.distance_miles || 999);
                    }
                });

                return comps;
            }, [cmaData, activeTab, sortBy, filterBy, subjectProperty]);

            const displayedComps = useMemo(() => {
                if (viewMode === 'compact') {
                    return sortedAndFilteredComps.slice(0, visibleCount);
                }
                return sortedAndFilteredComps;
            }, [sortedAndFilteredComps, viewMode, visibleCount]);

            const toggleComp = (comp) => setSelectedComps(prev =>
                prev.find(c => c.id === comp.id)
                    ? prev.filter(c => c.id !== comp.id)
                    : [...prev, comp]
            );

            const getConditionColor = (condition) => {
                const conditionMap = {
                    'Excellent': 'text-green-600',
                    'Good': 'text-blue-600',
                    'Average': 'text-yellow-600',
                    'Fair': 'text-orange-600',
                    'Poor': 'text-red-600'
                };
                return conditionMap[condition] || 'text-gray-600';
            };

            const getStatusBadge = (comp) => {
                if (comp.isActive) {
                    return <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Active</span>;
                } else {
                    return <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Sold</span>;
                }
            };

            // Function to show property details modal
            const showPropertyDetails = async (comp) => {
                setModalProperty(comp);
                setShowModal(true);
                setModalLoading(true);
                setModalDetails(null);

                try {
                    const response = await fetch('http://gbcma.us-east-2.elasticbeanstalk.com/api/property-details-from-address', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ address: comp.address })
                    });

                    if (response.ok) {
                        const details = await response.json();
                        setModalDetails(details);
                    } else {
                        setModalDetails({ error: 'Failed to fetch property details' });
                    }
                } catch (error) {
                    console.error('Error fetching property details:', error);
                    setModalDetails({ error: 'Network error fetching details' });
                } finally {
                    setModalLoading(false);
                }
            };

            return (
                <div id="comparables-section" className="animate-fade-in relative lg:pr-[320px]">
                    {/* Desktop Cart Sidebar (Amazon style) */}
                    <div className="hidden lg:block fixed top-24 right-6 w-72 z-[1200] print:hidden">
                        <div className="bg-white/95 backdrop-blur-md border border-gray-200/60 rounded-2xl shadow-xl flex flex-col max-h-[70vh]">
                            <div className="px-5 py-4 border-b flex items-center justify-between">
                                <h4 className="font-semibold text-gray-800 flex items-center gap-2 text-sm"><span className="inline-flex items-center justify-center w-6 h-6 rounded-full bg-sky-100 text-sky-600 font-bold text-xs">{selectedComps.length}</span> Selected Comps</h4>
                                <button onClick={() => setSelectedComps([])} disabled={!selectedComps.length} className="text-[11px] text-sky-600 hover:text-sky-700 disabled:text-gray-300">Clear</button>
                            </div>
                            <div className="overflow-auto p-4 space-y-3 text-sm flex-1">
                                {selectedComps.length === 0 && <p className="text-gray-500 text-xs">Add properties using the Add button. Pick up to 5.</p>}
                                {selectedComps.map(comp => (
                                    <div key={comp.id} className="group border border-gray-200 rounded-lg p-3 bg-white hover:shadow-sm transition relative">
                                        <button onClick={() => toggleComp(comp)} className="absolute -top-2 -right-2 bg-red-500 text-white w-5 h-5 rounded-full text-[10px] leading-5 flex items-center justify-center shadow hover:bg-red-600">√ó</button>
                                        <p className="font-medium text-gray-800 line-clamp-2 leading-snug mb-1">{comp.address}</p>
                                        <div className="flex justify-between text-[11px] text-gray-600">
                                            <span>{comp.sqft?.toLocaleString()} sf</span>
                                            <span>${(comp.soldPrice || comp.listPrice || 0).toLocaleString()}</span>
                                        </div>
                                        <div className="text-[10px] text-gray-400 mt-1 flex justify-between">
                                            <span>
                                                {comp.distance_miles !== undefined && comp.distance_miles !== null
                                                    ? comp.distance_miles === 0
                                                        ? 'Subject'
                                                        : `${comp.distance_miles.toFixed(2)} mi`
                                                    : 'No location'
                                                }
                                            </span>
                                            <span>{comp.isActive ? 'Active' : 'Sold'}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <div className="p-4 border-t space-y-3">
                                <div className="flex items-center justify-between text-[11px] text-gray-500">
                                    <span>Progress</span>
                                    <span>{selectedComps.length}/5</span>
                                </div>
                                <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                    <div className="h-2 bg-gradient-to-r from-sky-400 to-blue-600" style={{ width: `${Math.min(selectedComps.length / 5 * 100, 100)}%` }}></div>
                                </div>
                                <button onClick={nextStep} disabled={selectedComps.length < 1} className={`w-full py-3 rounded-lg text-sm font-semibold flex items-center justify-center gap-2 transition ${selectedComps.length ? 'bg-gradient-to-r from-sky-600 to-blue-600 text-white hover:from-sky-700 hover:to-blue-700 shadow' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}>
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                    Generate Report
                                </button>
                                <button onClick={prevStep} className="w-full py-2.5 rounded-lg text-xs font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 border border-gray-300">‚Üê Back to Details</button>
                            </div>
                        </div>
                    </div>

                    {/* Mobile / Tablet bottom cart bar */}
                    {(() => {
                        const [showDrawer, setShowDrawer] = React.useState(false); // local state via IIFE component isn't possible; convert to inline component below
                    })()}
                    {/* Use inline component for bottom drawer */}
                    {React.createElement(() => {
                        const [open, setOpen] = React.useState(false);
                        return (
                            <div className="lg:hidden fixed bottom-0 left-0 right-0 z-[1200] print:hidden">
                                {/* Collapsed Bar */}
                                <div className="flex items-center justify-between px-4 py-3 bg-white/95 backdrop-blur border-t border-gray-200 shadow-xl">
                                    <button onClick={prevStep} className="px-3 py-2 text-xs font-medium bg-gray-100 rounded-md border border-gray-300 text-gray-700">Details</button>
                                    <button onClick={() => setOpen(o => !o)} className="flex-1 mx-3 flex items-center justify-center gap-2 py-2 rounded-md bg-sky-600 text-white text-sm font-semibold">
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2 6h14M10 21a1 1 0 100-2 1 1 0 000 2zm8 0a1 1 0 100-2 1 1 0 000 2z" /></svg>
                                        {selectedComps.length} Selected
                                    </button>
                                    <button onClick={nextStep} disabled={!selectedComps.length} className={`px-3 py-2 text-xs font-medium rounded-md ${selectedComps.length ? 'bg-gradient-to-r from-sky-500 to-blue-600 text-white' : 'bg-gray-300 text-gray-500'}`}>Report</button>
                                </div>
                                {/* Drawer */}
                                {open && (
                                    <div className="max-h-[55vh] overflow-auto bg-white border-t border-gray-200 shadow-2xl animate-fade-in">
                                        <div className="flex items-center justify-between px-4 py-3 border-b">
                                            <h4 className="text-sm font-semibold">Selected ({selectedComps.length}/5)</h4>
                                            <div className="flex gap-2">
                                                <button onClick={() => setSelectedComps([])} disabled={!selectedComps.length} className="text-[11px] text-sky-600 disabled:text-gray-300">Clear</button>
                                                <button onClick={() => setOpen(false)} className="text-gray-500 text-sm">Close</button>
                                            </div>
                                        </div>
                                        <div className="p-4 space-y-3">
                                            {selectedComps.length === 0 && <p className="text-xs text-gray-500">No properties selected yet.</p>}
                                            {selectedComps.map(comp => (
                                                <div key={comp.id} className="border rounded-lg p-3 flex items-start gap-3 bg-gray-50">
                                                    <div className="flex-1 min-w-0">
                                                        <p className="text-xs font-medium text-gray-800 truncate">{comp.address}</p>
                                                        <p className="text-[10px] text-gray-500">{comp.sqft?.toLocaleString()} sf ‚Ä¢ ${(comp.soldPrice || comp.listPrice || 0).toLocaleString()}</p>
                                                    </div>
                                                    <button onClick={() => toggleComp(comp)} className="text-[10px] px-2 py-1 rounded bg-red-500 text-white">Remove</button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        );
                    })}

                    <div className="mb-6">
                        <h2 className="text-2xl font-bold text-gray-800 mb-2">Step 2: Select Comparable Properties</h2>
                        <p className="text-gray-600 mb-4">
                            Choose 3-5 of the most relevant properties using the comprehensive checklist below.
                            <span className="text-sky-600 font-medium"> Found {cmaData.counts.active} active, {cmaData.counts.closed} sold ({cmaData.counts.total} total)</span>
                        </p>

                        {/* Debug Subject Property Info */}
                        <div className="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-xs">
                            <strong>Subject Property Debug:</strong>
                            Address: {subjectProperty.address} |
                            Sq Ft: {subjectProperty.sqft || 'N/A'} |
                            Year: {subjectProperty.yearBuilt || 'N/A'} |
                            City: {subjectProperty.city || 'N/A'} |
                            Style: {subjectProperty.style || 'N/A'} |
                            Subdivision: {subjectProperty.subdivision || 'N/A'} |
                            Coordinates: {subjectProperty.latitude && subjectProperty.longitude
                                ? `${subjectProperty.latitude}, ${subjectProperty.longitude}`
                                : 'N/A'}
                        </div>

                        {/* Enhanced Status Tabs */}
                        <div className="mb-8">
                            <div className="bg-white rounded-xl p-2 shadow-lg border border-gray-200">
                                <nav className="flex space-x-2">
                                    <button
                                        onClick={() => setActiveTab('all')}
                                        className={`flex-1 py-3 px-6 text-sm font-semibold rounded-lg transition-all duration-200 flex items-center justify-center ${activeTab === 'all'
                                            ? 'bg-gradient-to-r from-sky-500 to-blue-500 text-white shadow-md transform scale-105'
                                            : 'text-gray-600 hover:text-gray-800 hover:bg-gray-50'
                                            }`}
                                    >
                                        <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                                        </svg>
                                        All Properties ({cmaData.counts.total})
                                    </button>
                                    <button
                                        onClick={() => setActiveTab('active')}
                                        className={`flex-1 py-3 px-6 text-sm font-semibold rounded-lg transition-all duration-200 flex items-center justify-center ${activeTab === 'active'
                                            ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-md transform scale-105'
                                            : 'text-gray-600 hover:text-gray-800 hover:bg-gray-50'
                                            }`}
                                    >
                                        <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                                        </svg>
                                        Active Listings ({cmaData.counts.active})
                                    </button>
                                    <button
                                        onClick={() => setActiveTab('closed')}
                                        className={`flex-1 py-3 px-6 text-sm font-semibold rounded-lg transition-all duration-200 flex items-center justify-center ${activeTab === 'closed'
                                            ? 'bg-gradient-to-r from-blue-500 to-indigo-500 text-white shadow-md transform scale-105'
                                            : 'text-gray-600 hover:text-gray-800 hover:bg-gray-50'
                                            }`}
                                    >
                                        <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        Recent Sales ({cmaData.counts.closed})
                                    </button>
                                </nav>
                            </div>
                        </div>

                        {/* View Mode Toggle */}
                        <div className="flex flex-wrap items-center gap-3 mb-4">
                            <span className="text-xs font-semibold text-gray-500 uppercase tracking-wide">View:</span>
                            <div className="inline-flex rounded-lg overflow-hidden border border-gray-200 bg-white shadow-sm">
                                <button
                                    type="button"
                                    onClick={() => setViewMode('detailed')}
                                    className={`px-4 py-2 text-xs font-medium transition ${viewMode === 'detailed' ? 'bg-sky-600 text-white' : 'text-gray-600 hover:bg-gray-50'}`}
                                >üìã Detailed</button>
                                <button
                                    type="button"
                                    onClick={() => setViewMode('compact')}
                                    className={`px-4 py-2 text-xs font-medium border-l border-gray-200 transition ${viewMode === 'compact' ? 'bg-sky-600 text-white' : 'text-gray-600 hover:bg-gray-50'}`}
                                >üèòÔ∏è Compact Grid</button>
                                <button
                                    type="button"
                                    onClick={() => setViewMode('map')}
                                    className={`px-4 py-2 text-xs font-medium border-l border-gray-200 transition ${viewMode === 'map' ? 'bg-sky-600 text-white' : 'text-gray-600 hover:bg-gray-50'}`}
                                >üó∫Ô∏è Map View</button>
                            </div>
                            {viewMode === 'compact' && (
                                <span className="text-xs text-gray-500">Showing {displayedComps.length} of {sortedAndFilteredComps.length}</span>
                            )}

                            {/* Expand Search Toggle */}
                            <button
                                type="button"
                                onClick={() => setShowExpandSearch(!showExpandSearch)}
                                className="inline-flex items-center px-3 py-2 text-xs font-medium text-sky-700 bg-sky-50 border border-sky-200 rounded-lg hover:bg-sky-100 transition"
                            >
                                üîç Expand Search ({cmaData.counts.total} found)
                            </button>
                        </div>

                        {/* Expand Search Controls */}
                        {showExpandSearch && (
                            <div className="mb-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                                <h4 className="text-sm font-semibold text-gray-800 mb-3">Adjust Search Parameters</h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs font-medium text-gray-700 mb-1">
                                            Search Radius: {expandedRadius} miles
                                        </label>
                                        <input
                                            type="range"
                                            min="0.5"
                                            max="10"
                                            step="0.5"
                                            value={expandedRadius}
                                            onChange={(e) => setExpandedRadius(parseFloat(e.target.value))}
                                            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                        />
                                        <div className="flex justify-between text-xs text-gray-500 mt-1">
                                            <span>0.5 mi</span>
                                            <span>Current: {subjectProperty.radiusMiles} mi</span>
                                            <span>10 mi</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-gray-700 mb-1">
                                            Square Footage Range: ¬±{expandedSqftDelta} sq ft
                                        </label>
                                        <input
                                            type="range"
                                            min="100"
                                            max="2000"
                                            step="100"
                                            value={expandedSqftDelta}
                                            onChange={(e) => setExpandedSqftDelta(parseInt(e.target.value))}
                                            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                        />
                                        <div className="flex justify-between text-xs text-gray-500 mt-1">
                                            <span>¬±100</span>
                                            <span>Current: ¬±{subjectProperty.sqftDelta}</span>
                                            <span>¬±2000</span>
                                        </div>
                                    </div>
                                </div>
                                <div className="flex gap-2 mt-4">
                                    <button
                                        type="button"
                                        onClick={handleExpandSearch}
                                        disabled={loading}
                                        className="px-4 py-2 text-xs font-medium text-white bg-sky-600 hover:bg-sky-700 rounded-lg disabled:opacity-50 transition"
                                    >
                                        {loading ? 'Searching...' : 'Update Search'}
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => setShowExpandSearch(false)}
                                        className="px-4 py-2 text-xs font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg transition"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Enhanced Controls */}
                    <div className="bg-gradient-to-r from-gray-50 to-blue-50 p-6 rounded-xl mb-6 border border-gray-200 shadow-sm">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="space-y-2">
                                <label className="flex items-center text-sm font-semibold text-gray-800 mb-3">
                                    <svg className="w-4 h-4 mr-2 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                                    </svg>
                                    Sort by:
                                </label>
                                <div className="relative">
                                    <select
                                        value={sortBy}
                                        onChange={(e) => setSortBy(e.target.value)}
                                        className="w-full pl-4 pr-10 py-3 text-sm bg-white border-2 border-gray-200 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 transition-all duration-200 hover:border-gray-300 appearance-none cursor-pointer font-medium"
                                    >
                                        <option value="distance">üéØ Distance (closest first)</option>
                                        <option value="price">üí∞ Price (highest first)</option>
                                        <option value="size">üìê Size (largest first)</option>
                                        <option value="date">üìÖ Date (newest first)</option>
                                    </select>
                                    <div className="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                        <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            <div className="space-y-2">
                                <label className="flex items-center text-sm font-semibold text-gray-800 mb-3">
                                    <svg className="w-4 h-4 mr-2 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.207A1 1 0 013 6.5V4z" />
                                    </svg>
                                    Filter by:
                                </label>
                                <div className="relative">
                                    <select
                                        value={filterBy}
                                        onChange={(e) => setFilterBy(e.target.value)}
                                        className="w-full pl-4 pr-10 py-3 text-sm bg-white border-2 border-gray-200 rounded-lg shadow-sm focus:border-sky-500 focus:ring-2 focus:ring-sky-200 transition-all duration-200 hover:border-gray-300 appearance-none cursor-pointer font-medium"
                                    >
                                        <option value="all">üè† All properties</option>
                                        <option value="similar_size">üìè Similar size (¬±500 sq ft)</option>
                                        <option value="similar_age">üóìÔ∏è Similar age (¬±10 years)</option>
                                        <option value="similar_style">üè° Similar style</option>
                                        <option value="similar_subdivision">üèòÔ∏è Same subdivision</option>
                                        <option value="active_only">üü¢ Active listings only</option>
                                        <option value="closed_only">üîµ Sold properties only</option>
                                    </select>
                                    <div className="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                        <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                    {/* Main Content Area */}
                    <div className="lg:pr-6">
                        {loading ? (
                            <div className="text-center py-8">
                                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-sky-600 mx-auto mb-4"></div>
                                <p>Loading comparable properties...</p>
                            </div>
                        ) : (
                            <div className={`${viewMode === 'compact' ? 'overflow-visible pr-0' : 'overflow-y-auto pr-4'} ${viewMode === 'compact' ? '' : 'space-y-6'}`} style={viewMode === 'compact' ? undefined : { maxHeight: 'calc(100vh - 180px)' }}>
                                {/* Content will continue here... */}
                            </div>
                        )}
                    </div>

                    {/* Property Details Modal */}
                    {showModal && (
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4 mb-6">
                                {displayedComps.map(comp => {
                                    const isSelected = selectedComps.some(c => c.id === comp.id);
                                    const price = comp.soldPrice || comp.listPrice || 0;
                                    const pricePerSqft = price && comp.sqft ? Math.round(price / comp.sqft) : 0;
                                    return (
                                        <div key={comp.id} className={`relative border rounded-lg p-3 bg-white transition shadow-sm hover:shadow-md ${isSelected ? 'ring-2 ring-sky-500' : 'border-gray-200'}`}>
                                            <button
                                                onClick={() => toggleComp(comp)}
                                                className={`absolute top-2 right-2 text-[10px] px-2 py-1 rounded-md font-semibold shadow ${isSelected ? 'bg-amber-500 text-white' : 'bg-sky-600 text-white hover:bg-sky-700'}`}
                                            >{isSelected ? '‚úì' : 'Add'}</button>
                                            <img
                                                src={comp.imageUrl}
                                                alt={comp.address}
                                                className="w-full h-28 object-cover rounded-md mb-2"
                                                onError={(e) => { e.target.style.display = 'none'; }}
                                            />
                                            <h3 className="text-xs font-semibold text-gray-800 leading-snug mb-1 line-clamp-2">{comp.address}</h3>
                                            <div className="flex flex-wrap gap-x-2 gap-y-1 text-[10px] text-gray-600">
                                                <span className="font-medium text-gray-800">${price.toLocaleString()}</span>
                                                {comp.sqft && <span>{comp.sqft.toLocaleString()} sf</span>}
                                                {pricePerSqft > 0 && <span>${pricePerSqft}/sf</span>}
                                                {comp.distance_miles !== undefined && comp.distance_miles !== null &&
                                                    <span>
                                                        {comp.distance_miles === 0 ? 'Subject' : `${comp.distance_miles.toFixed(2)} mi`}
                                                    </span>
                                                }
                                                <span className={`px-1.5 py-0.5 rounded-full text-[9px] font-semibold ${comp.isActive ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>{comp.isActive ? 'Active' : 'Sold'}</span>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}

                        {viewMode === 'map' && (
                            <div className="bg-white rounded-lg border border-gray-200 overflow-hidden">
                                <div className="p-4 border-b border-gray-200">
                                    <h3 className="text-lg font-semibold text-gray-800 mb-2">Property Map View</h3>
                                    <div className="flex flex-wrap gap-4 text-sm">
                                        <div className="flex items-center gap-2">
                                            <span className="text-red-500">üè†</span>
                                            <span>Subject Property</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span className="text-green-500">üü¢</span>
                                            <span>Active Listings</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span className="text-blue-500">üîµ</span>
                                            <span>Recent Sales</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span className="text-yellow-500">‚≠ê</span>
                                            <span>Selected Comparables</span>
                                        </div>
                                    </div>
                                </div>
                                <div style={{ height: '600px' }}>
                                    <MapComponent
                                        subjectProperty={subjectProperty}
                                        comparables={displayedComps}
                                        selectedComps={selectedComps}
                                        onSelectComp={toggleComp}
                                    />
                                </div>
                            </div>
                        )}

                        {viewMode === 'detailed' && displayedComps.map(comp => {
                            const isSelected = selectedComps.some(c => c.id === comp.id);
                            const price = comp.soldPrice || comp.listPrice || 0;
                            const pricePerSqft = price && comp.sqft ? Math.round(price / comp.sqft) : 0;

                            return (
                                <div
                                    key={comp.id}
                                    className={`bg-white rounded-lg shadow-md overflow-hidden transition-all border-2 ${isSelected ? 'border-sky-500 bg-sky-50' : 'border-gray-200 hover:border-gray-300'
                                        }`}
                                >
                                    <div className="p-6">
                                        {/* Header */}
                                        <div className="flex justify-between items-start mb-4">
                                            <div className="flex-1">
                                                <div className="flex items-center gap-2 mb-1">
                                                    <h3 className="text-lg font-bold text-gray-800">{comp.address}</h3>
                                                    {getStatusBadge(comp)}
                                                </div>
                                                <p className="text-gray-600">{comp.city} ‚Ä¢ {comp.subdivision || 'N/A'}</p>
                                            </div>
                                            <div className="flex gap-2">
                                                <button
                                                    onClick={() => showPropertyDetails(comp)}
                                                    className="px-3 py-2 rounded-md text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors"
                                                >
                                                    üëÅÔ∏è Details
                                                </button>
                                                <button
                                                    onClick={() => toggleComp(comp)}
                                                    className={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${isSelected
                                                        ? 'bg-amber-500 text-white hover:bg-amber-600'
                                                        : 'bg-sky-600 text-white hover:bg-sky-700'
                                                        }`}
                                                >
                                                    {isSelected ? '‚úì Selected' : 'Select'}
                                                </button>
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                            {/* Left: Photo and Price */}
                                            <div className="space-y-4">
                                                <img
                                                    src={comp.imageUrl}
                                                    alt={`View of ${comp.address}`}
                                                    className="w-full h-48 object-cover rounded-md"
                                                    onError={(e) => {
                                                        e.target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzllYTNhOCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIFBob3RvPC90ZXh0Pjwvc3ZnPg==';
                                                    }}
                                                />

                                                {/* üè∑ Price & Market Context */}
                                                <div className={`p-4 rounded-md ${comp.isActive ? 'bg-green-50' : 'bg-blue-50'}`}>
                                                    <h4 className={`font-semibold mb-2 ${comp.isActive ? 'text-green-800' : 'text-blue-800'}`}>
                                                        üè∑ Price & Market
                                                    </h4>
                                                    <div className="space-y-1 text-sm">
                                                        {comp.isActive ? (
                                                            <>
                                                                <p><span className="font-medium">List Price:</span> <span className="text-green-600 font-bold">${comp.listPrice?.toLocaleString()}</span></p>
                                                                <p><span className="font-medium">Days on Market:</span> {comp.dom || 'New'}</p>
                                                                <p><span className="font-medium">Listed:</span> {comp.onMarketDate}</p>
                                                            </>
                                                        ) : (
                                                            <>
                                                                <p><span className="font-medium">Sold Price:</span> <span className="text-blue-600 font-bold">${comp.soldPrice?.toLocaleString()}</span></p>
                                                                {comp.listPrice && <p><span className="font-medium">List Price:</span> ${comp.listPrice?.toLocaleString()}</p>}
                                                                <p><span className="font-medium">Sale Date:</span> {comp.closeDate}</p>
                                                            </>
                                                        )}
                                                        <p><span className="font-medium">Price/Sq Ft:</span> <span className="font-semibold">${pricePerSqft}</span></p>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Property Specs Only */}
                                            <div className="space-y-4">
                                                {/* üè† Property Specs */}
                                                <div className="bg-indigo-50 p-4 rounded-md">
                                                    <h4 className="font-semibold text-indigo-800 mb-2">üè† Property Specs</h4>
                                                    <div className="space-y-1 text-sm">
                                                        <p><span className="font-medium">Living Area:</span> <span className="font-semibold">{comp.sqft?.toLocaleString()}</span> sq ft</p>
                                                        <p><span className="font-medium">Basement:</span> {comp.basementSqft ? `${comp.basementSqft.toLocaleString()} sq ft` : 'None'}</p>
                                                        <p><span className="font-medium">Lot Size:</span> {comp.lotSizeAcres ? `${comp.lotSizeAcres} acres` : 'N/A'}</p>
                                                        <p><span className="font-medium">Bed/Bath:</span> {comp.beds} bed, {comp.baths} bath</p>
                                                        <p><span className="font-medium">Garage:</span> {comp.garage} spaces</p>
                                                        <p><span className="font-medium">Year Built:</span> {comp.yearBuilt}</p>
                                                        <p><span className="font-medium">Style:</span> {comp.style || 'N/A'}</p>
                                                        <p><span className="font-medium">Subdivision:</span> {comp.subdivision || 'N/A'}</p>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Right: Condition & Features */}
                                            <div className="space-y-4">
                                                {/* üõ† Condition & Features */}
                                                <div className="bg-orange-50 p-4 rounded-md">
                                                    <h4 className="font-semibold text-orange-800 mb-2">üõ† Condition & Features</h4>
                                                    <div className="space-y-1 text-sm">
                                                        <p><span className="font-medium">Condition:</span>
                                                            <span className={`font-semibold ml-1 ${getConditionColor(comp.condition)}`}>
                                                                {comp.condition || 'Average'}
                                                            </span>
                                                        </p>
                                                        <p><span className="font-medium">Style:</span> {comp.propertyType || 'N/A'}</p>
                                                        <p><span className="font-medium">Stories:</span> {comp.stories || 'N/A'}</p>
                                                        <p><span className="font-medium">Pool:</span> {comp.pool ? 'Yes' : 'No'}</p>
                                                        <p><span className="font-medium">Deck/Patio:</span> {comp.deck ? 'Yes' : 'No'}</p>
                                                        <p><span className="font-medium">Updates:</span> {comp.updates || 'Standard'}</p>
                                                    </div>
                                                </div>

                                                {/* Enhanced Compatibility Score */}
                                                <div className="bg-gray-50 p-4 rounded-md border-2 border-dashed border-gray-300">
                                                    <h4 className="font-semibold text-gray-800 mb-2">üéØ Compatibility</h4>
                                                    <div className="space-y-2 text-xs">
                                                        <div className="flex justify-between">
                                                            <span>Size Match:</span>
                                                            {(() => {
                                                                const subjectSqft = subjectProperty.sqft || subjectProperty.aboveGradeSqft || 0;
                                                                const compSqft = comp.sqft || 0;
                                                                if (subjectSqft && compSqft) {
                                                                    const diff = Math.abs(compSqft - subjectSqft);
                                                                    const isGoodMatch = diff <= 200;
                                                                    const isOkMatch = diff <= 500;
                                                                    return (
                                                                        <span className={`font-semibold ${isGoodMatch ? 'text-green-600' : isOkMatch ? 'text-yellow-600' : 'text-gray-600'}`}>
                                                                            ¬±{diff} sq ft
                                                                        </span>
                                                                    );
                                                                } else {
                                                                    return <span className="text-gray-500">No data</span>;
                                                                }
                                                            })()}
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span>Age Match:</span>
                                                            {(() => {
                                                                const subjectYear = subjectProperty.yearBuilt || 0;
                                                                const compYear = comp.yearBuilt || 0;
                                                                if (subjectYear && compYear) {
                                                                    const diff = Math.abs(compYear - subjectYear);
                                                                    const isGoodMatch = diff <= 2;
                                                                    const isOkMatch = diff <= 5;
                                                                    return (
                                                                        <span className={`font-semibold ${isGoodMatch ? 'text-green-600' : isOkMatch ? 'text-yellow-600' : 'text-gray-600'}`}>
                                                                            ¬±{diff} years
                                                                        </span>
                                                                    );
                                                                } else {
                                                                    return <span className="text-gray-500">No data</span>;
                                                                }
                                                            })()}
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span>Distance:</span>
                                                            {(() => {
                                                                if (comp.distance_miles !== undefined && comp.distance_miles !== null) {
                                                                    if (comp.distance_miles === 0) {
                                                                        return <span className="text-blue-600 font-semibold">Subject</span>;
                                                                    }
                                                                    const isNear = comp.distance_miles <= 0.5;
                                                                    const isClose = comp.distance_miles <= 1.0;
                                                                    const isReasonable = comp.distance_miles <= 2.0;
                                                                    return (
                                                                        <span className={`font-semibold ${isNear ? 'text-green-600' : isClose ? 'text-blue-600' : isReasonable ? 'text-yellow-600' : 'text-gray-600'}`}>
                                                                            {comp.distance_miles.toFixed(2)} mi
                                                                        </span>
                                                                    );
                                                                } else {
                                                                    return <span className="text-gray-500">No location data</span>;
                                                                }
                                                            })()}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                        {viewMode === 'compact' && displayedComps.length < sortedAndFilteredComps.length && (
                            <div className="mt-4 flex justify-center">
                                <button
                                    onClick={() => setVisibleCount(c => c + 60)}
                                    className="px-6 py-3 text-sm font-semibold rounded-lg bg-gradient-to-r from-sky-600 to-blue-600 text-white shadow hover:from-sky-700 hover:to-blue-700"
                                >Load More ({sortedAndFilteredComps.length - displayedComps.length} more)</button>
                            </div>
                        )}
                    </div>
                )
            }

            {
                (!loading && sortedAndFilteredComps.length === 0) && (
                    <div className="text-center py-12 bg-white rounded-lg shadow-md">
                        <h3 className="text-xl font-semibold text-gray-700">No Matching Comps Found</h3>
                        <p className="text-gray-500 mt-2">Try adjusting the filters or subject property details.</p>
                    </div>
                )
            }

            {/* Selected Comps Summary */ }
            {
                selectedComps.length > 0 && (
                    <div className="mt-8 bg-sky-50 border border-sky-200 rounded-lg p-6">
                        <h3 className="text-lg font-semibold text-sky-800 mb-4">
                            Selected Comparables ({selectedComps.length})
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {selectedComps.map(comp => {
                                const price = comp.soldPrice || comp.listPrice || 0;
                                const pricePerSqft = price && comp.sqft ? Math.round(price / comp.sqft) : 0;
                                return (
                                    <div key={comp.id} className="bg-white p-3 rounded-md border border-sky-200">
                                        <div className="flex items-center gap-2 mb-1">
                                            <p className="font-medium text-gray-800 truncate flex-1">{comp.address}</p>
                                            {comp.isActive ?
                                                <span className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">Active</span> :
                                                <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Sold</span>
                                            }
                                        </div>
                                        <p className="text-sm text-gray-600">${price?.toLocaleString()} ‚Ä¢ {comp.sqft?.toLocaleString()} sq ft</p>
                                        <p className="text-xs text-gray-500">{comp.distance_miles?.toFixed(2)} mi ‚Ä¢ ${pricePerSqft}/sq ft</p>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                )
            }

            {/* Property Details Modal */ }
            {
                showModal && (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[2000] p-4">
                        <div className="bg-white rounded-lg max-w-4xl max-h-[90vh] overflow-y-auto w-full">
                            {/* Modal Header */}
                            <div className="sticky top-0 bg-white border-b px-6 py-4 flex items-center justify-between">
                                <h2 className="text-xl font-bold text-gray-800">
                                    üè† Property Details - {modalProperty?.address}
                                </h2>
                                <button
                                    onClick={() => setShowModal(false)}
                                    className="text-gray-500 hover:text-gray-700 text-2xl"
                                >
                                    √ó
                                </button>
                            </div>

                            {/* Modal Content */}
                            <div className="p-6">
                                {modalLoading ? (
                                    <div className="text-center py-8">
                                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-sky-600 mx-auto"></div>
                                        <p className="mt-4 text-gray-600">Loading detailed property information...</p>
                                    </div>
                                ) : modalDetails?.error ? (
                                    <div className="text-center py-8">
                                        <p className="text-red-600">‚ùå {modalDetails.error}</p>
                                        <p className="text-sm text-gray-500 mt-2">Try again or check with your data provider</p>
                                    </div>
                                ) : modalDetails ? (
                                    <div className="space-y-6">
                                        {/* Basic Info Grid */}
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                            {/* Property Details */}
                                            <div className="bg-blue-50 p-4 rounded-lg">
                                                <h3 className="font-semibold text-blue-800 mb-3">üè† Property Details</h3>
                                                <div className="space-y-2 text-sm">
                                                    <p><span className="font-medium">Property Type:</span> {modalDetails.PropertyType || 'N/A'}</p>
                                                    <p><span className="font-medium">Property Sub Type:</span> {modalDetails.PropertySubType || 'N/A'}</p>
                                                    <p><span className="font-medium">Living Area:</span> {modalDetails.AboveGradeFinishedArea?.toLocaleString() || 'N/A'} sq ft</p>
                                                    <p><span className="font-medium">Below Grade:</span> {modalDetails.BelowGradeFinishedArea?.toLocaleString() || 'N/A'} sq ft</p>
                                                    <p><span className="font-medium">Total Area:</span> {modalDetails.TotalFinishedArea?.toLocaleString() || 'N/A'} sq ft</p>
                                                    <p><span className="font-medium">Year Built:</span> {modalDetails.YearBuilt || 'N/A'}</p>
                                                    <p><span className="font-medium">Stories:</span> {modalDetails.StoriesTotal || modalDetails.Stories || 'N/A'}</p>
                                                </div>
                                            </div>

                                            {/* Room Details */}
                                            <div className="bg-green-50 p-4 rounded-lg">
                                                <h3 className="font-semibold text-green-800 mb-3">üõèÔ∏è Room Details</h3>
                                                <div className="space-y-2 text-sm">
                                                    <p><span className="font-medium">Bedrooms:</span> {modalDetails.BedroomsTotal || 'N/A'}</p>
                                                    <p><span className="font-medium">Bathrooms:</span> {modalDetails.BathroomsTotalInteger || modalDetails.BathroomsTotal || 'N/A'}</p>
                                                    <p><span className="font-medium">Full Baths:</span> {modalDetails.BathroomsFull || 'N/A'}</p>
                                                    <p><span className="font-medium">Half Baths:</span> {modalDetails.BathroomsHalf || 'N/A'}</p>
                                                    <p><span className="font-medium">Garage Spaces:</span> {modalDetails.GarageSpaces || 'N/A'}</p>
                                                    <p><span className="font-medium">Parking Total:</span> {modalDetails.ParkingTotal || 'N/A'}</p>
                                                    <p><span className="font-medium">Fireplaces:</span> {modalDetails.FireplacesTotal || 'N/A'}</p>
                                                </div>
                                            </div>

                                            {/* Lot & Location */}
                                            <div className="bg-purple-50 p-4 rounded-lg">
                                                <h3 className="font-semibold text-purple-800 mb-3">üìç Lot & Location</h3>
                                                <div className="space-y-2 text-sm">
                                                    <p><span className="font-medium">Lot Size:</span> {modalDetails.LotSizeAcres || 'N/A'} acres</p>
                                                    <p><span className="font-medium">Lot Sq Ft:</span> {modalDetails.LotSizeSquareFeet?.toLocaleString() || 'N/A'} sq ft</p>
                                                    <p><span className="font-medium">County:</span> {modalDetails.CountyOrParish || 'N/A'}</p>
                                                    <p><span className="font-medium">Subdivision:</span> {modalDetails.SubdivisionName || 'N/A'}</p>
                                                    <p><span className="font-medium">Postal Code:</span> {modalDetails.PostalCode || 'N/A'}</p>
                                                    <p><span className="font-medium">Latitude:</span> {modalDetails.Latitude || 'N/A'}</p>
                                                    <p><span className="font-medium">Longitude:</span> {modalDetails.Longitude || 'N/A'}</p>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Pricing & Market Info */}
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div className="bg-yellow-50 p-4 rounded-lg">
                                                <h3 className="font-semibold text-yellow-800 mb-3">üí∞ Pricing & Market</h3>
                                                <div className="space-y-2 text-sm">
                                                    <p><span className="font-medium">List Price:</span> ${modalDetails.ListPrice?.toLocaleString() || 'N/A'}</p>
                                                    <p><span className="font-medium">Close Price:</span> ${modalDetails.ClosePrice?.toLocaleString() || 'N/A'}</p>
                                                    <p><span className="font-medium">Price/Sq Ft:</span> ${modalDetails.ListPricePerSquareFoot || 'N/A'}</p>
                                                    <p><span className="font-medium">Status:</span> {modalDetails.StandardStatus || 'N/A'}</p>
                                                    <p><span className="font-medium">On Market Date:</span> {modalDetails.OnMarketDate || 'N/A'}</p>
                                                    <p><span className="font-medium">Close Date:</span> {modalDetails.CloseDate || 'N/A'}</p>
                                                    <p><span className="font-medium">Days on Market:</span> {modalDetails.DaysOnMarket || modalDetails.CumulativeDaysOnMarket || 'N/A'}</p>
                                                </div>
                                            </div>

                                            <div className="bg-orange-50 p-4 rounded-lg">
                                                <h3 className="font-semibold text-orange-800 mb-3">üîß Features & Condition</h3>
                                                <div className="space-y-2 text-sm">
                                                    <p><span className="font-medium">Architectural Style:</span> {Array.isArray(modalDetails.ArchitecturalStyle) ? modalDetails.ArchitecturalStyle.join(', ') : modalDetails.ArchitecturalStyle || 'N/A'}</p>
                                                    <p><span className="font-medium">Property Condition:</span> {Array.isArray(modalDetails.PropertyCondition) ? modalDetails.PropertyCondition.join(', ') : modalDetails.PropertyCondition || 'N/A'}</p>
                                                    <p><span className="font-medium">Construction:</span> {Array.isArray(modalDetails.ConstructionMaterials) ? modalDetails.ConstructionMaterials.join(', ') : modalDetails.ConstructionMaterials || 'N/A'}</p>
                                                    <p><span className="font-medium">Foundation:</span> {Array.isArray(modalDetails.FoundationDetails) ? modalDetails.FoundationDetails.join(', ') : modalDetails.FoundationDetails || 'N/A'}</p>
                                                    <p><span className="font-medium">Heating:</span> {Array.isArray(modalDetails.Heating) ? modalDetails.Heating.join(', ') : modalDetails.Heating || 'N/A'}</p>
                                                    <p><span className="font-medium">Cooling:</span> {Array.isArray(modalDetails.Cooling) ? modalDetails.Cooling.join(', ') : modalDetails.Cooling || 'N/A'}</p>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Schools & Neighborhood */}
                                        {(modalDetails.ElementarySchool || modalDetails.MiddleOrJuniorSchool || modalDetails.HighSchool) && (
                                            <div className="bg-indigo-50 p-4 rounded-lg">
                                                <h3 className="font-semibold text-indigo-800 mb-3">üéì Schools</h3>
                                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                                    <p><span className="font-medium">Elementary:</span> {modalDetails.ElementarySchool || 'N/A'}</p>
                                                    <p><span className="font-medium">Middle/Junior:</span> {modalDetails.MiddleOrJuniorSchool || 'N/A'}</p>
                                                    <p><span className="font-medium">High School:</span> {modalDetails.HighSchool || 'N/A'}</p>
                                                </div>
                                            </div>
                                        )}

                                        {/* Utilities & Systems */}
                                        <div className="bg-gray-50 p-4 rounded-lg">
                                            <h3 className="font-semibold text-gray-800 mb-3">‚ö° Utilities & Systems</h3>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                                <div>
                                                    <p><span className="font-medium">Electric:</span> {Array.isArray(modalDetails.Electric) ? modalDetails.Electric.join(', ') : modalDetails.Electric || 'N/A'}</p>
                                                    <p><span className="font-medium">Water Source:</span> {Array.isArray(modalDetails.WaterSource) ? modalDetails.WaterSource.join(', ') : modalDetails.WaterSource || 'N/A'}</p>
                                                    <p><span className="font-medium">Sewer:</span> {Array.isArray(modalDetails.Sewer) ? modalDetails.Sewer.join(', ') : modalDetails.Sewer || 'N/A'}</p>
                                                </div>
                                                <div>
                                                    <p><span className="font-medium">Internet:</span> {Array.isArray(modalDetails.InternetTypes) ? modalDetails.InternetTypes.join(', ') : modalDetails.InternetTypes || 'N/A'}</p>
                                                    <p><span className="font-medium">Phone:</span> {Array.isArray(modalDetails.PhoneTypes) ? modalDetails.PhoneTypes.join(', ') : modalDetails.PhoneTypes || 'N/A'}</p>
                                                    <p><span className="font-medium">Cable TV:</span> {Array.isArray(modalDetails.CableTvYN) ? modalDetails.CableTvYN.join(', ') : modalDetails.CableTvYN || 'N/A'}</p>
                                                </div>
                                            </div>
                                        </div>

                                        {/* MLS Info */}
                                        <div className="bg-red-50 p-4 rounded-lg">
                                            <h3 className="font-semibold text-red-800 mb-3">üìã MLS Information</h3>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                                <div>
                                                    <p><span className="font-medium">MLS Number:</span> {modalDetails.ListingKey || modalDetails.MLSNumber || 'N/A'}</p>
                                                    <p><span className="font-medium">Agent ID:</span> {modalDetails.ListAgentKey || 'N/A'}</p>
                                                    <p><span className="font-medium">Office ID:</span> {modalDetails.ListOfficeKey || 'N/A'}</p>
                                                </div>
                                                <div>
                                                    <p><span className="font-medium">Last Modified:</span> {modalDetails.ModificationTimestamp || 'N/A'}</p>
                                                    <p><span className="font-medium">Property Status:</span> {modalDetails.PropertyStatus || 'N/A'}</p>
                                                    <p><span className="font-medium">Possession:</span> {modalDetails.Possession || 'N/A'}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-center py-8">
                                        <p className="text-gray-600">Select a property to view detailed information</p>
                                    </div>
                                )}
                            </div>

                            {/* Modal Footer */}
                            <div className="sticky bottom-0 bg-white border-t px-6 py-4 flex justify-end">
                                <button
                                    onClick={() => setShowModal(false)}
                                    className="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
                                >
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                )}
                    </div>
                </div>
            );
        };

        const ReportStep = ({ subjectProperty, selectedComps, prevStep, startOver, propertyDetailsError, setPropertyDetailsError }) => {
            useEffect(() => {
                //console.log('ReportStep mounted');
                //console.log('Subject Property:', subjectProperty);
                //console.log('Selected Comps:', selectedComps);
            }, []);
            const [description, setDescription] = useState('');
            const [strategy, setStrategy] = useState('');
            const [isDescLoading, setIsDescLoading] = useState(false);
            const [isStratLoading, setIsStratLoading] = useState(false);
            const [aiVerdict, setAiVerdict] = useState('');
            const [isVerdictLoading, setIsVerdictLoading] = useState(false);
            const [subjectDetails, setSubjectDetails] = useState(null); // full raw details from server
            const [isExporting, setIsExporting] = useState(false);

            const avgPricePerSqft = useMemo(() => {
                if (selectedComps.length === 0) return 180;
                const validComps = selectedComps.filter(comp => comp.soldPrice && comp.sqft && comp.soldPrice > 0 && comp.sqft > 0);
                if (validComps.length === 0) return 180;
                return validComps.reduce((acc, comp) => acc + (comp.soldPrice / comp.sqft), 0) / validComps.length;
            }, [selectedComps]);

            const adjustments = useMemo(() => selectedComps.map(comp => {
                const adj = { id: comp.id, details: [] };
                let totalAdjustment = 0;

                // Helper function to get numeric value
                const getNumber = (val) => {
                    if (val === null || val === undefined || val === '') return 0;
                    const num = parseFloat(val);
                    return isNaN(num) ? 0 : num;
                };

                // Get numeric values for calculations
                const subjectSqft = getNumber(subjectProperty.sqft);
                const compSqft = getNumber(comp.sqft);
                const subjectBaths = getNumber(subjectProperty.baths);
                const compBaths = getNumber(comp.baths);
                const subjectBeds = getNumber(subjectProperty.beds);
                const compBeds = getNumber(comp.beds);
                const subjectGarage = getNumber(subjectProperty.garage);
                const compGarage = getNumber(comp.garage);
                const subjectBasement = getNumber(subjectProperty.basementSqft);
                const compBasement = getNumber(comp.basementSqft);

                // Sqft adjustment
                const sqftDiff = subjectSqft - compSqft;
                if (sqftDiff !== 0 && avgPricePerSqft > 0) {
                    const amount = sqftDiff * avgPricePerSqft;
                    adj.details.push({ feature: 'GLA (Sq. Ft.)', adjustment: amount });
                    totalAdjustment += amount;
                }

                // Bathroom adjustment
                const bathDiff = subjectBaths - compBaths;
                if (bathDiff !== 0) {
                    const amount = bathDiff * ADJUSTMENT_VALUES.BATH_FULL;
                    adj.details.push({ feature: 'Bathrooms', adjustment: amount });
                    totalAdjustment += amount;
                }

                // Bedroom adjustment
                const bedDiff = subjectBeds - compBeds;
                if (bedDiff !== 0) {
                    const amount = bedDiff * 7500;
                    adj.details.push({ feature: 'Bedrooms', adjustment: amount });
                    totalAdjustment += amount;
                }

                // Garage adjustment
                const garageDiff = subjectGarage - compGarage;
                if (garageDiff !== 0) {
                    const amount = garageDiff * ADJUSTMENT_VALUES.GARAGE_STALL;
                    adj.details.push({ feature: 'Garage Stalls', adjustment: amount });
                    totalAdjustment += amount;
                }

                // Basement adjustment
                const basementDiff = subjectBasement - compBasement;
                if (basementDiff !== 0) {
                    const amount = basementDiff * ADJUSTMENT_VALUES.BASEMENT_SQFT;
                    adj.details.push({ feature: 'Basement Finish', adjustment: amount });
                    totalAdjustment += amount;
                }

                // Condition adjustment
                const subjectConditionValue = ADJUSTMENT_VALUES.CONDITION[subjectProperty.condition] || 0;
                const compConditionValue = ADJUSTMENT_VALUES.CONDITION[comp.condition] || 0;
                const conditionDiff = subjectConditionValue - compConditionValue;
                if (conditionDiff !== 0) {
                    adj.details.push({ feature: 'Condition', adjustment: conditionDiff });
                    totalAdjustment += conditionDiff;
                }

                adj.total = totalAdjustment;
                adj.adjustedPrice = getNumber(comp.soldPrice) + totalAdjustment;
                return adj;
            }), [subjectProperty, selectedComps, avgPricePerSqft]);

            const finalValuation = useMemo(() => {
                if (adjustments.length === 0) return 0;
                const validAdjustments = adjustments.filter(adj => !isNaN(adj.adjustedPrice) && adj.adjustedPrice > 0);
                if (validAdjustments.length === 0) return 0;
                return validAdjustments.reduce((acc, adj) => acc + adj.adjustedPrice, 0) / validAdjustments.length;
            }, [adjustments]);

            const formatCurrency = (value) => {
                if (value === null || value === undefined || isNaN(value)) return '$0';
                return `${value > 0 ? '+' : ''}${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(value)}`;
            };
            const handlePrint = () => window.print();

            // --- EXPORT HELPERS ---
            const buildComparisonRows = () => {
                const fields = [
                    { key: 'status', label: 'Status' },
                    { key: 'soldPrice', label: 'Sold Price' },
                    { key: 'listPrice', label: 'List Price' },
                    { key: 'sqft', label: 'Living Area (SqFt)' },
                    { key: 'beds', label: 'Bedrooms' },
                    { key: 'baths', label: 'Bathrooms' },
                    { key: 'garage', label: 'Garage Spaces' },
                    { key: 'yearBuilt', label: 'Year Built' },
                    { key: 'propertyType', label: 'Property Type' },
                    { key: 'dom', label: 'Days on Market' },
                    { key: 'pricePerSqft', label: 'Price / SqFt' },
                    { key: 'lotSizeAcres', label: 'Lot Size (Acres)' },
                    { key: 'stories', label: 'Stories' }
                ];
                const rows = [];
                fields.forEach(f => {
                    const row = { Feature: f.label };
                    // Subject value
                    let subjectValue = subjectProperty[f.key];
                    if (['soldPrice', 'listPrice'].includes(f.key)) {
                        subjectValue = subjectValue ? subjectValue : '';
                    } else if (f.key === 'pricePerSqft') {
                        if (subjectProperty.pricePerSqft) subjectValue = subjectProperty.pricePerSqft;
                        else if (subjectProperty.listPrice && subjectProperty.sqft) subjectValue = Math.round(subjectProperty.listPrice / subjectProperty.sqft);
                        else if (subjectProperty.sqft && finalValuation > 0) subjectValue = Math.round(finalValuation / subjectProperty.sqft);
                        else subjectValue = '';
                    } else if (f.key === 'status') {
                        subjectValue = 'For Sale';
                    }
                    row.Subject = subjectValue || '';
                    selectedComps.forEach((comp, idx) => {
                        let v = comp[f.key];
                        if (['soldPrice', 'listPrice'].includes(f.key)) v = v ? v : '';
                        if (f.key === 'pricePerSqft') v = v ? v : '';
                        row[`Comp ${idx + 1}`] = (v || v === 0) ? v : '';
                    });
                    rows.push(row);
                });
                return rows;
            };

            // Helper to flatten nested objects for export (dot notation keys)
            const flattenObject = (obj, prefix = '', acc = {}) => {
                if (!obj || typeof obj !== 'object') return acc;
                Object.keys(obj).forEach(k => {
                    const val = obj[k];
                    const newKey = prefix ? `${prefix}.${k}` : k;
                    if (val && typeof val === 'object' && !Array.isArray(val)) {
                        flattenObject(val, newKey, acc);
                    } else {
                        acc[newKey] = Array.isArray(val) ? JSON.stringify(val) : val;
                    }
                });
                return acc;
            };

            // On-demand fetch of full subject details (only when exporting)
            const ensureSubjectDetails = async () => {
                if (subjectDetails || !subjectProperty.address) return subjectDetails;
                try {
                    const resp = await fetch('/api/property-details-from-address', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ address: subjectProperty.address })
                    });
                    if (!resp.ok) {
                        console.warn('Failed to fetch full subject details for export');
                        setPropertyDetailsError('Full property data not available (API lookup failed).');
                        return null;
                    }
                    const data = await resp.json();
                    setSubjectDetails(data);
                    setPropertyDetailsError('');
                    return data;
                } catch (e) {
                    console.error('Error fetching subject details for export:', e);
                    setPropertyDetailsError('Full property data not available (network error).');
                    return null;
                }
            };

            const exportToExcel = async () => {
                if (isExporting) return; // prevent double clicks
                setIsExporting(true);
                try {
                    const fullDetails = await ensureSubjectDetails();
                    // Flatten subject details (if available) for extended attributes
                    const flatSubject = fullDetails ? flattenObject(fullDetails) : {};
                    const excludePatterns = /(Media|Photo|Image|Directions|RemarksPublic|Permission|Instructions|IDX)/i;
                    const flatKeys = Object.keys(flatSubject).filter(k => !excludePatterns.test(k)).sort();

                    // Core comparison fields first
                    const coreFields = [
                        { key: 'status', label: 'Status' },
                        { key: 'soldPrice', label: 'Sold Price' },
                        { key: 'listPrice', label: 'List Price' },
                        { key: 'sqft', label: 'Living Area (SqFt)' },
                        { key: 'beds', label: 'Bedrooms' },
                        { key: 'baths', label: 'Bathrooms' },
                        { key: 'garage', label: 'Garage Spaces' },
                        { key: 'yearBuilt', label: 'Year Built' },
                        { key: 'propertyType', label: 'Property Type' },
                        { key: 'dom', label: 'Days on Market' },
                        { key: 'pricePerSqft', label: 'Price / SqFt' },
                        { key: 'lotSizeAcres', label: 'Lot Size (Acres)' },
                        { key: 'stories', label: 'Stories' }
                    ];

                    // Build header: Feature | Subject | each comp address
                    const header = ['Feature', 'Subject', ...selectedComps.map(c => c.address)];
                    const dataRows = [];

                    // Helper to compute subject value for core field
                    const subjectValueFor = (f) => {
                        if (f.key === 'soldPrice') return subjectProperty.soldPrice || '';
                        if (f.key === 'listPrice') return subjectProperty.listPrice || '';
                        if (f.key === 'pricePerSqft') {
                            if (subjectProperty.pricePerSqft) return subjectProperty.pricePerSqft;
                            if (subjectProperty.listPrice && subjectProperty.sqft) return Math.round(subjectProperty.listPrice / subjectProperty.sqft);
                            if (subjectProperty.sqft && finalValuation > 0) return Math.round(finalValuation / subjectProperty.sqft);
                            return '';
                        }
                        if (f.key === 'status') return 'For Sale';
                        return subjectProperty[f.key] || '';
                    };

                    // Core field rows
                    coreFields.forEach(f => {
                        const row = [f.label, subjectValueFor(f)];
                        selectedComps.forEach(comp => {
                            let v = comp[f.key];
                            if (['soldPrice', 'listPrice'].includes(f.key)) v = v || '';
                            if (f.key === 'pricePerSqft') v = v || '';
                            row.push(v == null ? '' : v);
                        });
                        dataRows.push(row);
                    });

                    // Blank separator or note if details missing
                    if (flatKeys.length) {
                        dataRows.push(['', '', ...selectedComps.map(() => '')]);
                    } else if (!fullDetails) {
                        dataRows.push(['Subject Full Details', 'Not Available', ...selectedComps.map(() => '')]);
                    }

                    // Extended subject detail rows
                    flatKeys.forEach(k => {
                        const row = [k, flatSubject[k]];
                        selectedComps.forEach(comp => {
                            // Direct key lookup only (no deep flatten for comps)
                            row.push(comp[k] != null ? comp[k] : '');
                        });
                        dataRows.push(row);
                    });

                    // Convert to worksheet manually (aoa_to_sheet)
                    const aoa = [header, ...dataRows];
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet(aoa);
                    XLSX.utils.book_append_sheet(wb, ws, 'Comparison');

                    // Adjustments sheet (keep separate)
                    if (adjustments.length) {
                        const adjRows = adjustments.map(a => {
                            const comp = selectedComps.find(c => c.id === a.id) || {};
                            return {
                                Address: comp.address,
                                OriginalPrice: comp.soldPrice || comp.listPrice || '',
                                TotalAdjustment: a.total,
                                AdjustedPrice: a.adjustedPrice
                            };
                        });
                        const ws2 = XLSX.utils.json_to_sheet(adjRows);
                        XLSX.utils.book_append_sheet(wb, ws2, 'Adjustments');
                    }

                    XLSX.writeFile(wb, `cma_comparison_${Date.now()}.xlsx`);
                } finally {
                    setIsExporting(false);
                }
            };

            const exportToCSV = async () => {
                if (isExporting) return;
                setIsExporting(true);
                try {
                    const fullDetails = await ensureSubjectDetails();
                    const rows = buildComparisonRows();
                    const headers = Object.keys(rows[0] || {});
                    let csv = [headers.join(',')].concat(rows.map(r => headers.map(h => JSON.stringify(r[h] ?? '')).join(','))).join('\n');
                    if (fullDetails) {
                        const flat = flattenObject(fullDetails);
                        csv += '\n\n"Subject Full Details"\nField,Value\n' + Object.keys(flat).sort().map(k => `${JSON.stringify(k)},${JSON.stringify(flat[k] ?? '')}`).join('\n');
                    } else {
                        csv += '\n\n"Subject Full Details","Not Available"';
                    }
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `cma_comparison_${Date.now()}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } finally {
                    setIsExporting(false);
                }
            };

            // (Removed full matrix UI & related state)

            const callGeminiAPI = async (prompt) => {
                try {
                    const response = await fetch('/api/generate-text', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt })
                    });
                    if (!response.ok) {
                        const errorBody = await response.json();
                        console.error('Gemini API Error Response:', errorBody);
                        throw new Error(`API call failed with status: ${response.status}`);
                    }
                    const result = await response.json();
                    return result.text || "No content generated.";
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    return `Error: Could not get a response from the AI. Please ensure your API key is valid and has billing enabled. ${error.message}`;
                }
            };

            const handleGenerateDescription = async () => {
                setIsDescLoading(true);
                setDescription('');
                const prompt = `You are a real estate agent. Write a compelling and professional MLS property description for the following home in Omaha, Nebraska.
                1.  Use the following core data from the IDX feed:
                    - Address: ${subjectProperty.address}
                    - City: ${subjectProperty.city}
                    - Style: ${subjectProperty.style}
                    - Price: Around ${formatCurrency(finalValuation)}
                    - Square Feet: ${subjectProperty.sqft}
                    - Bedrooms: ${subjectProperty.beds}
                    - Bathrooms: ${subjectProperty.baths}
                    - Garage Stalls: ${subjectProperty.garage}
                    - Year Built: ${subjectProperty.yearBuilt}
                    - Basement: ${subjectProperty.basementSqft > 0 ? `${subjectProperty.basementSqft} finished sq ft` : 'Unfinished'}
                    - Condition: ${subjectProperty.condition}
                2.  Enrich the description by incorporating the *type* of public-facing information you would find on Zillow for a property at this address (e.g., mention proximity to specific parks, schools, popular neighborhoods, or local amenities).
                3.  Keep the final description under 999 characters. Be enthusiastic but professional and do not use ALL CAPS.`;
                const result = await callGeminiAPI(prompt);
                setDescription(result);
                setIsDescLoading(false);
            };

            const handleGenerateStrategy = async () => {
                setIsStratLoading(true);
                setStrategy('');
                const avgDOM = selectedComps.reduce((acc, comp) => acc + comp.dom, 0) / selectedComps.length;
                const prompt = `As a real estate team lead in ${subjectProperty.city}, Nebraska, provide a concise listing strategy for a client.
                - Subject Property Condition: ${subjectProperty.condition}
                - Estimated Market Value: ${formatCurrency(finalValuation)}
                - Comps' Average Days on Market: ${avgDOM.toFixed(0)} days.
                Based on this data, suggest a recommended list price (e.g., at, slightly above, or slightly below market value) and a brief marketing suggestion. Keep it to 2-3 sentences.`;
                const result = await callGeminiAPI(prompt);
                setStrategy(result);
                setIsStratLoading(false);
            };

            const handleGenerateVerdict = async () => {
                setIsVerdictLoading(true);
                setAiVerdict('');
                try {
                    // Build subject details safely
                    const subjectDetails = `
                        - Address: ${subjectProperty.address}
                        - Style: ${subjectProperty.style}
                        - Condition: ${subjectProperty.condition}
                        - Living Area: ${subjectProperty.sqft || 'N/A'} sqft
                        - Basement: ${subjectProperty.basementSqft > 0 ? `${subjectProperty.basementSqft} finished sq ft` : 'Unfinished'}
                        - Beds/Baths: ${subjectProperty.beds || 'N/A'}/${subjectProperty.baths || 'N/A'}
                        - Garage: ${subjectProperty.garage || 'N/A'} stalls
                        - Year Built: ${subjectProperty.yearBuilt || 'N/A'}
                    `;

                    // Null-safe & limited comps (cap at 10 to control prompt size)
                    const compsSummary = selectedComps.slice(0, 10).map(c => `
                        - Comp Address: ${c.address}
                        - Status: ${c.isActive ? 'Active' : 'Sold'}
                        - Price: ${formatCurrency(c.soldPrice || c.listPrice)}
                        - Distance: ${c.distance_miles != null && !isNaN(c.distance_miles) ? c.distance_miles.toFixed(2) + ' miles' : 'N/A'}
                        - Sqft: ${c.sqft || 'N/A'}
                        - DOM: ${c.dom || 'N/A'}
                    `).join('');

                    const prompt = `As a senior real estate analyst using Google Gemini, provide a professional "AI Verdict" on a subject property based on the following Comparative Market Analysis (CMA) data.\n\n**Subject Property Details:**\n${subjectDetails}\n\n**Calculated Data:**\n- Estimated Market Value: ${formatCurrency(finalValuation)}\n- Average Price/SqFt of Comps: $${avgPricePerSqft.toFixed(2)}\n\n**Comparable Properties Summary:**\n${compsSummary}\n\n**Your Task:**\nBased *only* on the data provided, generate a concise, professional verdict. Address the following points in a structured format (using markdown for bolding and bullet points):\n1. **Overall Assessment:** One-sentence summary of the property's market position.\n2. **Valuation Confidence:** Indicate whether the estimated value appears solid, aggressive, or conservative, with 1 short reason.\n3. **Key Strengths:** 2-3 bullet points (advantages vs comps).\n4. **Potential Risks:** 2-3 bullet points (possible weaknesses / market concerns).\n5. **Final Recommendation:** Brief actionable suggestion (pricing & positioning).\n\nKeep the response professional, data-driven, and under 220 words.`;

                    const result = await callGeminiAPI(prompt);
                    setAiVerdict(result);
                } catch (err) {
                    console.error('AI Verdict generation error:', err);
                    setAiVerdict(`Error generating AI Verdict: ${err.message}`);
                } finally {
                    setIsVerdictLoading(false);
                }
            };

            return (
                <div className="animate-fade-in">
                    <div id="print-area" className="bg-white p-6 sm:p-8 rounded-lg shadow-lg">
                        <header className="border-b-2 border-gray-200 pb-4 mb-6"><div className="flex justify-between items-center"><div><h1 className="text-3xl font-bold text-sky-700">Simple CMA</h1><p className="text-gray-600">Comparative Market Analysis</p></div><div className="text-right"><p className="font-semibold">Omaha & Lincoln Real Estate</p><p className="text-sm text-gray-500">Generated: {new Date().toLocaleDateString()}</p></div></div></header>
                        <section id="summary" className="mb-8"><h2 className="text-xl font-bold text-gray-800 border-b border-gray-200 pb-2 mb-4">Valuation Summary</h2><div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div><h3 className="font-semibold text-gray-700">Subject Property</h3><p className="text-lg text-gray-900">{subjectProperty.address}</p><p className="text-gray-600">{subjectProperty.city}</p></div><div className="bg-sky-50 p-4 rounded-lg text-center"><h3 className="font-semibold text-sky-800">Estimated Market Value</h3><p className="text-4xl font-bold text-sky-700 tracking-tight mt-1">{formatCurrency(finalValuation)}</p><div className="flex justify-center gap-4 mt-2 text-sm"><span>Low: {formatCurrency(finalValuation * 0.98)}</span><span>High: {formatCurrency(finalValuation * 1.02)}</span></div></div></div></section>

                        <section id="ai-features" className="my-8 print-hidden">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <button onClick={handleGenerateDescription} disabled={isDescLoading} className="w-full inline-flex items-center justify-center rounded-md border border-transparent bg-sky-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-sky-700 disabled:bg-gray-400">
                                        {isDescLoading ? 'Generating...' : '‚ú® Generate Property Description'}
                                    </button>
                                    {description && <div className="mt-4 p-4 bg-gray-50 rounded-md border text-sm text-gray-700 whitespace-pre-wrap">{description}</div>}
                                </div>
                                <div>
                                    <button onClick={handleGenerateStrategy} disabled={isStratLoading} className="w-full inline-flex items-center justify-center rounded-md border border-transparent bg-sky-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-sky-700 disabled:bg-gray-400">
                                        {isStratLoading ? 'Generating...' : '‚ú® Suggest Listing Strategy'}
                                    </button>
                                    {strategy && <div className="mt-4 p-4 bg-gray-50 rounded-md border text-sm text-gray-700 whitespace-pre-wrap">{strategy}</div>}
                                </div>
                            </div>
                            <div className="bg-gradient-to-r from-sky-50 to-blue-50 p-6 rounded-xl border border-sky-200 shadow-sm">
                                <h3 className="text-lg font-bold text-sky-800 mb-3 text-center">AI Market Verdict</h3>
                                <div className="flex justify-center">
                                    <button onClick={handleGenerateVerdict} disabled={isVerdictLoading} className="inline-flex items-center justify-center rounded-full border border-transparent bg-gradient-to-r from-sky-600 to-blue-600 px-6 py-3 text-base font-medium text-white shadow-lg hover:from-sky-700 hover:to-blue-700 disabled:bg-gray-400 transform hover:scale-105 transition-transform">
                                        {isVerdictLoading ? 'Analyzing Data...' : '‚öñÔ∏è Get AI Verdict'}
                                    </button>
                                </div>
                                {aiVerdict && (
                                    <div className="mt-4 p-4 bg-white rounded-md border text-sm text-gray-800 whitespace-pre-wrap shadow-inner">
                                        <p className="text-xs text-gray-500 mb-2 font-semibold uppercase text-center">Powered by Google Gemini</p>
                                        {aiVerdict}
                                    </div>
                                )}
                            </div>
                        </section>

                        <section id="comparison-chart" className="mb-8"><h2 className="text-xl font-bold text-gray-800 border-b border-gray-200 pb-2 mb-4">Side-by-Side Comparison</h2><div className="overflow-x-auto"><table className="w-full text-sm text-left text-gray-500"><thead className="text-xs text-gray-700 uppercase bg-gray-50"><tr><th scope="col" className="py-3 px-6">Feature</th><th scope="col" className="py-3 px-6 bg-sky-50 text-sky-800">Subject Property</th>{selectedComps.map(comp => <th key={comp.id} scope="col" className="py-3 px-6">{comp.address}</th>)}</tr></thead><tbody>{[
                            { key: 'status', label: 'Status' },
                            { key: 'soldPrice', label: 'Sold Price' },
                            { key: 'listPrice', label: 'List Price' },
                            { key: 'sqft', label: 'Living Area' },
                            { key: 'beds', label: 'Bedrooms' },
                            { key: 'baths', label: 'Bathrooms' },
                            { key: 'garage', label: 'Garage Spaces' },
                            { key: 'yearBuilt', label: 'Year Built' },
                            { key: 'propertyType', label: 'Property Type' },
                            { key: 'style', label: 'Architectural Style' },
                            { key: 'subdivision', label: 'Subdivision' },
                            { key: 'dom', label: 'Days on Market' },
                            { key: 'pricePerSqft', label: '$/Sq Ft' },
                            { key: 'lotSizeAcres', label: 'Lot Size (Acres)' },
                            { key: 'stories', label: 'Stories' }
                        ].map(field => {
                            // Get subject property value with better handling
                            let subjectValue = 'N/A';
                            const propValue = subjectProperty[field.key];

                            if (field.key === 'soldPrice') {
                                subjectValue = subjectProperty.soldPrice ? `$${Number(subjectProperty.soldPrice).toLocaleString()}` : 'N/A';
                            } else if (field.key === 'listPrice') {
                                subjectValue = subjectProperty.listPrice ? `$${Number(subjectProperty.listPrice).toLocaleString()}` : 'N/A';
                            } else if (field.key === 'pricePerSqft') {
                                if (subjectProperty.pricePerSqft) {
                                    subjectValue = `$${subjectProperty.pricePerSqft}`;
                                } else if (subjectProperty.listPrice && subjectProperty.sqft) {
                                    subjectValue = `$${Math.round(subjectProperty.listPrice / subjectProperty.sqft)}`;
                                } else if (subjectProperty.sqft && finalValuation && finalValuation > 0) {
                                    subjectValue = `$${Math.round(finalValuation / subjectProperty.sqft)}`;
                                } else {
                                    subjectValue = 'N/A';
                                }
                            } else if (field.key === 'status') {
                                subjectValue = 'For Sale';
                            } else if (propValue !== null && propValue !== undefined && propValue !== '') {
                                // Debug logging for each field
                                //console.log(`Field ${field.key}:`, propValue, typeof propValue);
                                subjectValue = propValue;
                            }

                            //console.log(`Final ${field.key} value:`, subjectValue);

                            return (<tr key={field.key} className="bg-white border-b">
                                <td className="py-4 px-6 font-medium text-gray-900 whitespace-nowrap">{field.label}</td>
                                <td className="py-4 px-6 bg-sky-50 font-semibold">{subjectValue}</td>
                                {selectedComps.map(comp => <td key={comp.id} className="py-4 px-6">
                                    {['soldPrice', 'listPrice'].includes(field.key) ?
                                        `$${(comp[field.key] || 0).toLocaleString()}` :
                                        (field.key === 'pricePerSqft' ?
                                            `$${comp[field.key] || 0}` :
                                            (comp[field.key] && comp[field.key] !== '' && comp[field.key] !== 0 ? comp[field.key] : 'N/A')
                                        )
                                    }
                                </td>)}
                            </tr>);
                        })}</tbody></table></div></section>

                        <section id="property-details" className="mb-8">
                            <h2 className="text-xl font-bold text-gray-800 border-b border-gray-200 pb-2 mb-4">Property Details</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {selectedComps.map(comp => (
                                    <div key={comp.id} className="bg-gray-50 p-4 rounded-lg">
                                        <h3 className="font-semibold text-gray-800 mb-3">{comp.address}</h3>
                                        <div className="text-sm space-y-1">
                                            {comp.heating && <p><span className="font-medium">Heating:</span> {comp.heating}</p>}
                                            {comp.cooling && <p><span className="font-medium">Cooling:</span> {comp.cooling}</p>}
                                            {comp.basement && <p><span className="font-medium">Basement:</span> {comp.basement}</p>}
                                            {comp.fireplace && <p><span className="font-medium">Fireplaces:</span> {comp.fireplace}</p>}
                                            {comp.pool && <p><span className="font-medium">Pool:</span> {comp.pool ? 'Yes' : 'No'}</p>}
                                            {comp.schoolElementary && <p><span className="font-medium">Elementary:</span> {comp.schoolElementary}</p>}
                                            {comp.schoolHigh && <p><span className="font-medium">High School:</span> {comp.schoolHigh}</p>}
                                            {comp.mlsNumber && <p><span className="font-medium">MLS #:</span> {comp.mlsNumber}</p>}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </section>

                        <section id="adjustments"><h2 className="text-xl font-bold text-gray-800 border-b border-gray-200 pb-2 mb-4">Valuation Adjustments</h2><div className="overflow-x-auto"><table className="w-full text-sm text-left text-gray-500"><thead className="text-xs text-gray-700 uppercase bg-gray-50"><tr><th scope="col" className="py-3 px-6">Comp Property</th><th scope="col" className="py-3 px-6">Adjustment Feature</th><th scope="col" className="py-3 px-6 text-right">Adjustment Value</th></tr></thead><tbody>{selectedComps.map((comp) => { const compAdjustments = adjustments.find(a => a.id === comp.id); const salePrice = comp.soldPrice || comp.listPrice || 0; return (<React.Fragment key={comp.id}><tr className="bg-white font-semibold"><td rowSpan={compAdjustments.details.length + 2} className="py-4 px-6 border-b border-r">{comp.address}<br /><span className="font-normal">{comp.isActive ? 'Listed' : 'Sold'}: ${salePrice.toLocaleString()}</span></td></tr>{compAdjustments.details.map((detail, detailIndex) => (<tr key={detailIndex} className="bg-white"><td className="py-1 px-6">{detail.feature}</td><td className={`py-1 px-6 text-right font-mono ${detail.adjustment > 0 ? 'text-green-600' : 'text-red-600'}`}>{formatCurrency(detail.adjustment)}</td></tr>))}<tr className="bg-gray-50 font-bold"><td className="py-2 px-6 text-gray-800">Adjusted Sale Price</td><td className="py-2 px-6 text-right text-gray-800 font-mono">${compAdjustments.adjustedPrice.toLocaleString(undefined, { maximumFractionDigits: 0 })}</td></tr></React.Fragment>); })}</tbody></table></div></section>
                        <footer className="text-center text-xs text-gray-500 pt-8 mt-8 border-t"><p>This report is an estimate of value based on available data and is not a formal appraisal. Market conditions can change rapidly.</p><p>Simple CMA ¬© {new Date().getFullYear()}</p></footer>
                    </div>
                    <div className="flex justify-between mt-8 print-hidden">
                        <button onClick={prevStep} className="inline-flex justify-center rounded-md border border-gray-300 bg-white py-2 px-4 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">Back to Comps</button>
                        <div className="flex flex-wrap items-center gap-3">
                            <button onClick={startOver} className="inline-flex justify-center rounded-md border border-transparent bg-amber-500 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-amber-600">Start New Report</button>
                            <button onClick={handlePrint} className="inline-flex items-center justify-center rounded-md border border-transparent bg-sky-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-sky-700">
                                <svg className="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M5 2.75C5 1.784 5.784 1 6.75 1h6.5c.966 0 1.75.784 1.75 1.75v3.552c.377.135.74.34 1.057.592l.001.001c.454.37.742.92.742 1.524V15a2 2 0 01-2 2H5a2 2 0 01-2-2V8.418c0-.604.288-1.154.742-1.524l.001-.001a2.986 2.986 0 011.057-.592V2.75zM6.5 2.5a.25.25 0 00-.25.25v3.5a.75.75 0 00.75.75h6.5a.75.75 0 00.75-.75v-3.5a.25.25 0 00-.25-.25h-6.5zM5 8.418a1.5 1.5 0 01-.37.918l-.001.001a.25.25 0 00.184.413h10.372a.25.25 0 00.184-.413l-.001-.001A1.5 1.5 0 0115 8.418V15a.5.5 0 01-.5.5H5.5a.5.5 0 01-.5-.5V8.418z" clipRule="evenodd" /><path d="M7.25 10a.75.75 0 01.75.75v.01a.75.75 0 01-1.5 0V10.75a.75.75 0 01.75-.75zM10 10a.75.75 0 01.75.75v.01a.75.75 0 01-1.5 0V10.75A.75.75 0 0110 10z" /></svg>
                                Print
                            </button>
                            <button onClick={exportToExcel} disabled={isExporting} className={`inline-flex items-center justify-center rounded-md border border-transparent py-2 px-4 text-sm font-medium text-white shadow-sm ${isExporting ? 'bg-emerald-400 cursor-wait' : 'bg-emerald-600 hover:bg-emerald-700'}`}>
                                <span className="mr-2">üìä</span>{isExporting ? 'Exporting...' : 'Excel'}
                            </button>
                            <button onClick={exportToCSV} disabled={isExporting} className={`inline-flex items-center justify-center rounded-md border border-transparent py-2 px-4 text-sm font-medium text-white shadow-sm ${isExporting ? 'bg-indigo-400 cursor-wait' : 'bg-indigo-600 hover:bg-indigo-700'}`}>
                                <span className="mr-2">üìÑ</span>{isExporting ? 'Exporting...' : 'CSV'}
                            </button>
                            {propertyDetailsError && (
                                <span className="text-xs text-red-600 font-medium">{propertyDetailsError}</span>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const initialSubjectState = {
                address: '',
                city: '',
                sqft: '',
                basementSqft: '',
                yearBuilt: '',
                beds: '',
                baths: '',
                garage: '',
                condition: 'Average',
                style: '',
                radiusMiles: 2,
                sqftDelta: 700,
                propertyType: '',
                propertySubType: '',
                listPrice: '',
                soldPrice: '',
                lotSizeAcres: '',
                lotSizeSquareFeet: '',
                stories: '',
                dom: '',
                pricePerSqft: ''
            };
            const [step, setStep] = useState(1);
            const [subjectProperty, setSubjectProperty] = useState(initialSubjectState);
            const [selectedComps, setSelectedComps] = useState([]);
            const [showExplorer, setShowExplorer] = useState(false);
            const [propertyDetailsError, setPropertyDetailsError] = useState('');

            return (
                <div className="min-h-screen bg-gradient-to-br from-sky-50 via-white to-blue-50">
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
                        <ProgressBar step={step} setStep={setStep} />
                        <div className="mt-10">
                            {step === 1 && (
                                <SubjectPropertyStep
                                    subjectProperty={subjectProperty}
                                    setSubjectProperty={setSubjectProperty}
                                    nextStep={() => setStep(2)}
                                    propertyDetailsError={propertyDetailsError}
                                    setPropertyDetailsError={setPropertyDetailsError}
                                />
                            )}
                            {step === 2 && (
                                <ComparablesStep
                                    subjectProperty={subjectProperty}
                                    selectedComps={selectedComps}
                                    setSelectedComps={setSelectedComps}
                                    prevStep={() => setStep(1)}
                                    nextStep={() => setStep(3)}
                                />
                            )}
                            {step === 3 && (
                                <ReportStep
                                    subjectProperty={subjectProperty}
                                    selectedComps={selectedComps}
                                    prevStep={() => setStep(2)}
                                    startOver={() => { setSubjectProperty(initialSubjectState); setSelectedComps([]); setStep(1); }}
                                    propertyDetailsError={propertyDetailsError}
                                    setPropertyDetailsError={setPropertyDetailsError}
                                />
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>

</html>